<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“± ã‚·ãƒ³ãƒ—ãƒ«ã‚«ãƒ¡ãƒ© + 3D ãƒ†ã‚¹ãƒˆ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 12px;
      max-width: 250px;
    }
    
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      z-index: 1000;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    .success { color: #44ff44; }
    .error { color: #ff4444; }
    .warning { color: #ffaa44; }
    .info { color: #4488ff; }
  </style>
</head>
<body>
  <div id="container">
    <div id="status">
      <div id="statusText">åˆæœŸåŒ–ä¸­...</div>
    </div>
    
    <div id="controls">
      <h3>ğŸ“± ã‚·ãƒ³ãƒ—ãƒ«ã‚«ãƒ¡ãƒ© + 3D ãƒ†ã‚¹ãƒˆ</h3>
      <p id="instruction">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™ä¸­...</p>
      <button id="startBtn" onclick="startAR()" style="display: none;">ğŸš€ ARé–‹å§‹</button>
      <button id="placeBtn" onclick="placeObject()" style="display: none;">ğŸ“¦ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®</button>
    </div>
  </div>

  <!-- Three.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script>
    const statusEl = document.getElementById('statusText');
    const instructionEl = document.getElementById('instruction');
    const startBtn = document.getElementById('startBtn');
    const placeBtn = document.getElementById('placeBtn');
    const container = document.getElementById('container');
    
    let camera, scene, renderer;
    let video;
    let arActive = false;
    let placedObjects = [];

    function updateStatus(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
      statusEl.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
    }

    function updateInstruction(text) {
      instructionEl.textContent = text;
    }

    // ã‚¹ãƒ†ãƒƒãƒ—1: åŸºæœ¬ç’°å¢ƒãƒã‚§ãƒƒã‚¯
    async function checkEnvironment() {
      updateStatus('ğŸ” ç’°å¢ƒãƒã‚§ãƒƒã‚¯é–‹å§‹', 'info');
      
      // Three.js ãƒã‚§ãƒƒã‚¯
      if (!window.THREE) {
        throw new Error('Three.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      updateStatus('âœ… Three.js ç¢ºèªå®Œäº†', 'success');
      
      // WebGL ãƒã‚§ãƒƒã‚¯
      const canvas = document.createElement('canvas');
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (!gl) {
        throw new Error('WebGL ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      updateStatus('âœ… WebGL ã‚µãƒãƒ¼ãƒˆç¢ºèª', 'success');
      
      // MediaDevices API ãƒã‚§ãƒƒã‚¯
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('ã‚«ãƒ¡ãƒ©APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      updateStatus('âœ… ã‚«ãƒ¡ãƒ©API ã‚µãƒãƒ¼ãƒˆç¢ºèª', 'success');
      
      updateStatus('âœ… ç’°å¢ƒãƒã‚§ãƒƒã‚¯å®Œäº†', 'success');
    }

    // ã‚¹ãƒ†ãƒƒãƒ—2: Three.js åˆæœŸåŒ–
    function initThreeJS() {
      updateStatus('ğŸ¨ Three.js åˆæœŸåŒ–ä¸­', 'info');
      
      // ã‚·ãƒ¼ãƒ³ä½œæˆ
      scene = new THREE.Scene();
      
      // ã‚«ãƒ¡ãƒ©ä½œæˆï¼ˆé€šå¸¸ã®PerspectiveCameraï¼‰
      camera = new THREE.PerspectiveCamera(
        75, 
        window.innerWidth / window.innerHeight, 
        0.1, 
        1000
      );
      camera.position.set(0, 0, 5);
      
      // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
      renderer = new THREE.WebGLRenderer({ 
        antialias: true, 
        alpha: true 
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      renderer.domElement.style.position = 'absolute';
      renderer.domElement.style.top = '0';
      renderer.domElement.style.left = '0';
      renderer.domElement.style.zIndex = '2';
      renderer.domElement.style.pointerEvents = 'none';
      
      container.appendChild(renderer.domElement);
      
      // ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      updateStatus('âœ… Three.js åˆæœŸåŒ–å®Œäº†', 'success');
    }

    // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
    async function initCamera() {
      updateStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ä¸­', 'warning');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        // ãƒ“ãƒ‡ã‚ªè¦ç´ ä½œæˆ
        video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        video.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
          z-index: 1;
        `;
        
        container.appendChild(video);
        
        await video.play();
        updateStatus('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ', 'success');
        
      } catch (error) {
        updateStatus(`âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        throw error;
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
    function startRenderLoop() {
      updateStatus('ğŸ¬ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹', 'info');
      
      function animate() {
        requestAnimationFrame(animate);
        
        // é…ç½®ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å›è»¢
        placedObjects.forEach(obj => {
          obj.rotation.x += 0.01;
          obj.rotation.y += 0.01;
        });
        
        renderer.render(scene, camera);
      }
      
      animate();
      updateStatus('âœ… ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹å®Œäº†', 'success');
    }

    // ARé–‹å§‹
    async function startAR() {
      startBtn.style.display = 'none';
      
      try {
        await checkEnvironment();
        initThreeJS();
        await initCamera();
        startRenderLoop();
        
        arActive = true;
        placeBtn.style.display = 'inline-block';
        renderer.domElement.style.pointerEvents = 'auto';
        
        updateStatus('ğŸ‰ ARæº–å‚™å®Œäº†', 'success');
        updateInstruction('ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã‹ã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„');
        
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
        renderer.domElement.addEventListener('touchstart', handleTouch);
        renderer.domElement.addEventListener('click', handleTouch);
        
      } catch (error) {
        updateStatus(`âŒ ARé–‹å§‹å¤±æ•—: ${error.message}`, 'error');
        updateInstruction('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®
    function placeObject() {
      if (!arActive) return;
      
      updateStatus('ğŸ“¦ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®ä¸­', 'info');
      
      // ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã®ã‚­ãƒ¥ãƒ¼ãƒ–ã‚’ä½œæˆ
      const geometry = new THREE.BoxGeometry(1, 1, 1);
      const material = new THREE.MeshLambertMaterial({ 
        color: Math.random() * 0xffffff 
      });
      const cube = new THREE.Mesh(geometry, material);
      
      // ç”»é¢ä¸­å¤®ä»˜è¿‘ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
      cube.position.set(
        (Math.random() - 0.5) * 4,
        (Math.random() - 0.5) * 2,
        -3
      );
      
      scene.add(cube);
      placedObjects.push(cube);
      
      updateStatus(`âœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®å®Œäº† (${placedObjects.length}å€‹ç›®)`, 'success');
      updateInstruction(`${placedObjects.length}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã™`);
    }

    // ã‚¿ãƒƒãƒãƒ»ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ«
    function handleTouch(event) {
      event.preventDefault();
      placeObject();
    }

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });

    // åˆæœŸåŒ–
    window.addEventListener('load', () => {
      updateStatus('ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«ARåˆæœŸåŒ–æº–å‚™å®Œäº†', 'success');
      updateInstruction('AR.jsã‚’ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚«ãƒ¡ãƒ©+3Dè¡¨ç¤ºãƒ†ã‚¹ãƒˆ');
      startBtn.style.display = 'inline-block';
    });
  </script>
</body>
</html>