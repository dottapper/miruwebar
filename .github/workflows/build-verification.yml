name: Build Verification

on:
  push:
    branches: [main, indexeddb-storage-refactor]
  pull_request:
    branches: [main, indexeddb-storage-refactor]

jobs:
  build-verification:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Clean previous builds
        run: |
          rm -rf dist/
          rm -rf .vite/
          rm -rf node_modules/.vite/

      - name: Build project
        run: npm run build

      - name: Verify build output structure
        run: |
          echo "ğŸ” ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ã®æ§‹é€ ã‚’æ¤œè¨¼ä¸­..."

          # distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
          if [ ! -d "dist" ]; then
            echo "âŒ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
          required_files=("index.html" "assets/")
          for file in "${required_files[@]}"; do
            if [ ! -e "dist/$file" ]; then
              echo "âŒ å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $file"
              exit 1
            fi
          done

          # assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ç¢ºèª
          echo "ğŸ“ assetsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la dist/assets/

          # ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªï¼ˆJS/CSSãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã€ãƒãƒƒã‚·ãƒ¥ãŒ8æ–‡å­—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
          echo "ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œè¨¼ï¼ˆJS/CSSãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰:"
          js_css_files=0
          valid_files=0
          for file in dist/assets/*.{js,css}; do
            if [ ! -f "$file" ]; then
              continue
            fi
            js_css_files=$((js_css_files + 1))
            filename=$(basename "$file")
            if [[ $filename =~ \.[a-f0-9]{8}\.(js|css)$ ]]; then
              echo "âœ… æ­£ã—ã„ãƒãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³: $filename"
              valid_files=$((valid_files + 1))
            else
              echo "âš ï¸ ãƒãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä¸€è‡´ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰: $filename"
            fi
          done
          
          if [ $js_css_files -eq 0 ]; then
            echo "âš ï¸ JS/CSSãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          else
            echo "ğŸ“Š JS/CSSãƒ•ã‚¡ã‚¤ãƒ«: $js_css_filesä»¶ã€æœ‰åŠ¹ãªãƒ‘ã‚¿ãƒ¼ãƒ³: $valid_filesä»¶"
          fi

          echo "âœ… ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ã®æ§‹é€ æ¤œè¨¼å®Œäº†"

      - name: Verify build determinism
        run: |
          echo "ğŸ”„ ãƒ“ãƒ«ãƒ‰ã®æ±ºå®šæ€§ã‚’æ¤œè¨¼ä¸­..."

          # 2å›ç›®ã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
          rm -rf dist/
          npm run build

          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’æ¯”è¼ƒï¼ˆãƒãƒƒã‚·ãƒ¥ã¯ç•°ãªã‚‹ãŒã€æ§‹é€ ã¯åŒã˜ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
          echo "ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœã®çµ±è¨ˆ:"
          echo "1å›ç›®ã®ãƒ“ãƒ«ãƒ‰:"
          find dist/ -type f -name "*.js" | wc -l
          echo "2å›ç›®ã®ãƒ“ãƒ«ãƒ‰:"
          find dist/ -type f -name "*.js" | wc -l

          echo "âœ… ãƒ“ãƒ«ãƒ‰ã®æ±ºå®šæ€§æ¤œè¨¼å®Œäº†"

      - name: Generate build report
        run: |
          echo "ğŸ“‹ ãƒ“ãƒ«ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."

          echo "# ãƒ“ãƒ«ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆ" > build-report.md
          echo "## ç”Ÿæˆæ—¥æ™‚" >> build-report.md
          echo "$(date)" >> build-report.md
          echo "" >> build-report.md
          echo "## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ " >> build-report.md
          echo '```' >> build-report.md
          find dist/ -type f | sort >> build-report.md
          echo '```' >> build-report.md
          echo "" >> build-report.md
          echo "## ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º" >> build-report.md
          echo '```' >> build-report.md
          du -h dist/assets/* >> build-report.md
          echo '```' >> build-report.md

          echo "âœ… ãƒ“ãƒ«ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist/
            .vite/
          key: ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-
