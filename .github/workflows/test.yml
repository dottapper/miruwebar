name: Test

on:
  push:
    branches: [ main, indexeddb-storage-refactor ]
  pull_request:
    branches: [ main, indexeddb-storage-refactor ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm run test:run

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true

  test-ui:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run UI tests
      run: npm run test:ui -- --reporter=verbose
      timeout-minutes: 10

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for linting issues
      run: |
        # ESLintãŒã‚ã‚Œã°å®Ÿè¡Œ
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
          npm run lint
        else
          echo "No ESLint configuration found, skipping lint step"
        fi

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit (production dependencies only)
      run: |
        echo "ğŸ” æœ¬ç•ªä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œä¸­..."
        npm audit --production --audit-level=high || true
        echo "âœ… æœ¬ç•ªä¾å­˜é–¢ä¿‚ã®ç›£æŸ»å®Œäº†"

    - name: Check for high severity vulnerabilities in production
      run: |
        echo "ğŸ” é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ã®ãƒã‚§ãƒƒã‚¯ä¸­..."
        if npm audit --production --audit-level=high 2>&1 | grep -q "found 0 vulnerabilities"; then
          echo "âœ… æœ¬ç•ªä¾å­˜é–¢ä¿‚ã«é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        else
          echo "âš ï¸ æœ¬ç•ªä¾å­˜é–¢ä¿‚ã«é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          npm audit --production --audit-level=high
          exit 1
        fi

    - name: Report dev dependencies vulnerabilities (warning only)
      run: |
        echo "âš ï¸ é–‹ç™ºä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆï¼ˆè­¦å‘Šã®ã¿ï¼‰:"
        npm audit --audit-level=moderate || echo "é–‹ç™ºä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã¯æœ¬ç•ªç’°å¢ƒã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“"
