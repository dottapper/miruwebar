<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified State Manager Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #121212; color: white; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #2e7d32; }
        .error { background: #d32f2f; }
        .info { background: #1976d2; }
        button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .test-btn { background: #7c4dff; color: white; }
        .clear-btn { background: #ff5252; color: white; }
        #output { margin-top: 20px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>çµ±ä¸€çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h1>
    
    <div>
        <button class="test-btn" onclick="testBasicOperations()">åŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆ</button>
        <button class="test-btn" onclick="testStateSubscription()">çŠ¶æ…‹è³¼èª­ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-btn" onclick="testStorageAdapters()">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-btn" onclick="testProjectState()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ãƒ†ã‚¹ãƒˆ</button>
        <button class="clear-btn" onclick="clearOutput()">çµæœã‚¯ãƒªã‚¢</button>
    </div>
    
    <div id="output"></div>

    <script type="module">
        import { unifiedStateManager } from './src/utils/unified-state-manager.js';
        import { markAsChanged, checkForUnsavedChanges, markAsSaved } from './src/views/editor/project-state.js';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ã—ã¦ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
        window.unifiedStateManager = unifiedStateManager;
        window.markAsChanged = markAsChanged;
        window.checkForUnsavedChanges = checkForUnsavedChanges;
        window.markAsSaved = markAsSaved;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        window.log = log;

        // çµ±ä¸€çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
        unifiedStateManager.initialize().then(() => {
            log('âœ… çµ±ä¸€çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
        }).catch(error => {
            log(`âŒ çµ±ä¸€çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
        });

        // åŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆ
        window.testBasicOperations = async function() {
            try {
                log('ğŸ”„ åŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

                // çŠ¶æ…‹è¨­å®šãƒ†ã‚¹ãƒˆ
                await unifiedStateManager.setState('testKey', 'testValue', {
                    namespace: 'test',
                    storageType: 'memory'
                });
                log('âœ… çŠ¶æ…‹è¨­å®šå®Œäº†', 'success');

                // çŠ¶æ…‹å–å¾—ãƒ†ã‚¹ãƒˆ
                const value = await unifiedStateManager.getState('testKey', {
                    namespace: 'test'
                });
                
                if (value === 'testValue') {
                    log('âœ… çŠ¶æ…‹å–å¾—æˆåŠŸ: ' + value, 'success');
                } else {
                    log('âŒ çŠ¶æ…‹å–å¾—å¤±æ•—: æœŸå¾…å€¤=testValue, å®Ÿéš›å€¤=' + value, 'error');
                }

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—
                const debugInfo = unifiedStateManager.getDebugInfo();
                log(`ğŸ“Š ãƒ‡ãƒãƒƒã‚°æƒ…å ±: ${JSON.stringify(debugInfo)}`, 'info');

            } catch (error) {
                log(`âŒ åŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // çŠ¶æ…‹è³¼èª­ãƒ†ã‚¹ãƒˆ
        window.testStateSubscription = async function() {
            try {
                log('ğŸ”„ çŠ¶æ…‹è³¼èª­ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

                let callbackCount = 0;
                const unsubscribe = unifiedStateManager.subscribe('subscriptionTest', (value, key) => {
                    callbackCount++;
                    log(`ğŸ“¢ è³¼èª­ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ ${callbackCount}: ${key} = ${value}`, 'info');
                }, { namespace: 'test' });

                // çŠ¶æ…‹å¤‰æ›´
                await unifiedStateManager.setState('subscriptionTest', 'value1', {
                    namespace: 'test',
                    storageType: 'memory'
                });

                await unifiedStateManager.setState('subscriptionTest', 'value2', {
                    namespace: 'test',
                    storageType: 'memory'
                });

                if (callbackCount === 2) {
                    log('âœ… çŠ¶æ…‹è³¼èª­ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                } else {
                    log(`âŒ çŠ¶æ…‹è³¼èª­ãƒ†ã‚¹ãƒˆå¤±æ•—: æœŸå¾…ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ•°=2, å®Ÿéš›=${callbackCount}`, 'error');
                }

                // è³¼èª­è§£é™¤
                unsubscribe();
                log('âœ… è³¼èª­è§£é™¤å®Œäº†', 'success');

            } catch (error) {
                log(`âŒ çŠ¶æ…‹è³¼èª­ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆ
        window.testStorageAdapters = async function() {
            try {
                log('ğŸ”„ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

                // ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ
                await unifiedStateManager.setState('memoryTest', 'memoryValue', {
                    namespace: 'test',
                    storageType: 'memory'
                });

                const memoryValue = await unifiedStateManager.getState('memoryTest', {
                    namespace: 'test',
                    storageTypes: ['memory']
                });

                if (memoryValue === 'memoryValue') {
                    log('âœ… ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                } else {
                    log('âŒ ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆå¤±æ•—', 'error');
                }

                // localStorageãƒ†ã‚¹ãƒˆ
                await unifiedStateManager.setState('localStorageTest', 'localStorageValue', {
                    namespace: 'test',
                    storageType: 'localStorage'
                });

                const localStorageValue = await unifiedStateManager.getState('localStorageTest', {
                    namespace: 'test',
                    storageTypes: ['localStorage']
                });

                if (localStorageValue === 'localStorageValue') {
                    log('âœ… localStorageãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                } else {
                    log('âŒ localStorageãƒ†ã‚¹ãƒˆå¤±æ•—', 'error');
                }

            } catch (error) {
                log(`âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ãƒ†ã‚¹ãƒˆ
        window.testProjectState = async function() {
            try {
                log('ğŸ”„ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ãƒ†ã‚¹ãƒˆé–‹å§‹...', 'info');

                // åˆæœŸçŠ¶æ…‹ç¢ºèª
                const initialState = await checkForUnsavedChanges();
                log(`ğŸ“‹ åˆæœŸçŠ¶æ…‹: ${initialState}`, 'info');

                // å¤‰æ›´çŠ¶æ…‹ã«è¨­å®š
                await markAsChanged();
                const changedState = await checkForUnsavedChanges();
                
                if (changedState === true) {
                    log('âœ… å¤‰æ›´çŠ¶æ…‹è¨­å®šæˆåŠŸ', 'success');
                } else {
                    log('âŒ å¤‰æ›´çŠ¶æ…‹è¨­å®šå¤±æ•—', 'error');
                }

                // ä¿å­˜æ¸ˆã¿çŠ¶æ…‹ã«è¨­å®š
                await markAsSaved();
                const savedState = await checkForUnsavedChanges();
                
                if (savedState === false) {
                    log('âœ… ä¿å­˜æ¸ˆã¿çŠ¶æ…‹è¨­å®šæˆåŠŸ', 'success');
                } else {
                    log('âŒ ä¿å­˜æ¸ˆã¿çŠ¶æ…‹è¨­å®šå¤±æ•—', 'error');
                }

            } catch (error) {
                log(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // çµæœã‚¯ãƒªã‚¢
        window.clearOutput = function() {
            document.getElementById('output').innerHTML = '';
        };

        log('ğŸš€ ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–å®Œäº†', 'success');
    </script>
</body>
</html>