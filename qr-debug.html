<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .error { color: red; }
        .success { color: green; }
        canvas { border: 1px solid #ddd; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ‡ãƒãƒƒã‚°</h1>
    
    <div class="test-section">
        <h2>1. QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
        <div id="library-test">ãƒ†ã‚¹ãƒˆä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>2. QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ</h2>
        <div id="generation-test">ãƒ†ã‚¹ãƒˆä¸­...</div>
        <canvas id="test-canvas" width="200" height="200"></canvas>
    </div>
    
    <div class="test-section">
        <h2>3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLç”Ÿæˆãƒ†ã‚¹ãƒˆ</h2>
        <div id="url-test">ãƒ†ã‚¹ãƒˆä¸­...</div>
    </div>

    <script type="module">
        // QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        async function testQRCodeLibrary() {
            const testDiv = document.getElementById('library-test');
            try {
                console.log('ğŸ”„ QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const qrcodeModule = await import('qrcode');
                const QRCode = qrcodeModule.default;
                
                console.log('âœ… QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªå–å¾—æˆåŠŸ:', QRCode);
                console.log('âœ… toCanvas method:', typeof QRCode.toCanvas);
                
                testDiv.innerHTML = `
                    <div class="success">âœ… QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿æˆåŠŸ</div>
                    <div>Type: ${typeof QRCode}</div>
                    <div>toCanvas method: ${typeof QRCode.toCanvas}</div>
                `;
                
                return QRCode;
            } catch (error) {
                console.error('âŒ QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                testDiv.innerHTML = `
                    <div class="error">âŒ QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿å¤±æ•—</div>
                    <div>Error: ${error.message}</div>
                `;
                return null;
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ
        async function testQRCodeGeneration(QRCode) {
            const testDiv = document.getElementById('generation-test');
            const canvas = document.getElementById('test-canvas');
            
            if (!QRCode) {
                testDiv.innerHTML = '<div class="error">âŒ QRCodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</div>';
                return;
            }
            
            try {
                console.log('ğŸ”„ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆé–‹å§‹...');
                const testUrl = 'https://localhost:3000/#/viewer?src=https://localhost:3000/projects/sample/project.json';
                
                await QRCode.toCanvas(canvas, testUrl, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
                
                console.log('âœ… QRã‚³ãƒ¼ãƒ‰ç”ŸæˆæˆåŠŸ');
                testDiv.innerHTML = `
                    <div class="success">âœ… QRã‚³ãƒ¼ãƒ‰ç”ŸæˆæˆåŠŸ</div>
                    <div>URL: ${testUrl}</div>
                    <div>Canvas size: ${canvas.width}x${canvas.height}</div>
                `;
            } catch (error) {
                console.error('âŒ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                testDiv.innerHTML = `
                    <div class="error">âŒ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå¤±æ•—</div>
                    <div>Error: ${error.message}</div>
                    <div>Stack: ${error.stack}</div>
                `;
            }
        }
        
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLç”Ÿæˆãƒ†ã‚¹ãƒˆ
        async function testProjectURLGeneration() {
            const testDiv = document.getElementById('url-test');
            
            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯IPã‚’å–å¾—
                const localIP = await getLocalNetworkIP();
                const currentPort = window.location.port || '3000';
                const localHost = `${localIP}:${currentPort}`;
                const scheme = (window.location.protocol === 'https:') ? 'https' : 'http';
                
                const projectId = 'sample';
                const localUrl = `${scheme}://${localHost}/#/viewer?src=${scheme}://${localHost}/projects/${encodeURIComponent(projectId)}/project.json`;
                
                console.log('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLç”ŸæˆæˆåŠŸ:', localUrl);
                testDiv.innerHTML = `
                    <div class="success">âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLç”ŸæˆæˆåŠŸ</div>
                    <div>Local IP: ${localIP}</div>
                    <div>Port: ${currentPort}</div>
                    <div>URL: ${localUrl}</div>
                `;
                
                return localUrl;
            } catch (error) {
                console.error('âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                testDiv.innerHTML = `
                    <div class="error">âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLç”Ÿæˆå¤±æ•—</div>
                    <div>Error: ${error.message}</div>
                `;
                return null;
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯IPã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getLocalNetworkIP() {
            return new Promise((resolve) => {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        const candidate = event.candidate.candidate;
                        const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                        if (ipMatch) {
                            const ip = ipMatch[1];
                            if (ip.startsWith('192.168.') || ip.startsWith('10.') || ip.startsWith('172.')) {
                                pc.close();
                                resolve(ip);
                                return;
                            }
                        }
                    }
                };
                
                setTimeout(() => {
                    pc.close();
                    resolve('192.168.1.100'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                }, 3000);
            });
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        (async () => {
            console.log('ğŸš€ QRã‚³ãƒ¼ãƒ‰ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            const QRCode = await testQRCodeLibrary();
            await testQRCodeGeneration(QRCode);
            await testProjectURLGeneration();
            
            console.log('âœ… ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº†');
        })();
    </script>
</body>
</html>
