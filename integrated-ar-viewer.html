<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“± çµ±åˆARãƒ“ãƒ¥ãƒ¼ã‚¢</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    
    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    #loadingScreen h2 {
      color: #ffffff;
      margin-bottom: 20px;
    }
    
    #loadingProgress {
      width: 300px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      overflow: hidden;
    }
    
    #loadingBar {
      height: 100%;
      background: #6c5ce7;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 12px;
      max-width: 300px;
      line-height: 1.3;
      display: none;
    }
    
    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      z-index: 1000;
      max-width: 320px;
    }
    
    #qrScanner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 900;
      display: none;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover { background: #0056b3; }
    
    .success { color: #44ff44; }
    .error { color: #ff4444; }
    .warning { color: #ffaa44; }
    .info { color: #4488ff; }
    
    #markerGuide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border: 3px dashed #4CAF50;
      border-radius: 10px;
      z-index: 500;
      display: none;
      background: rgba(76, 175, 80, 0.1);
    }
    
    #markerGuide::before {
      content: "ğŸ“± ãƒãƒ¼ã‚«ãƒ¼ã‚’ã“ã“ã«";
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      white-space: nowrap;
    }
    
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 250px;
      background: white;
      color: black;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loadingScreen">
      <h2 id="loadingTitle">ARãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</h2>
      <div id="loadingProgress">
        <div id="loadingBar"></div>
      </div>
      <p id="loadingMessage">ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...</p>
    </div>
    
    <!-- QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ -->
    <div id="qrScanner">
      <h3>ğŸ“± QRã‚³ãƒ¼ãƒ‰ ã¾ãŸã¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL</h3>
      <input type="text" id="projectUrlInput" placeholder="QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯URLã‚’å…¥åŠ›">
      <br>
      <button onclick="loadProjectFromUrl()">ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿</button>
      <button onclick="loadSampleProject()">ğŸ“¦ ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿</button>
      <br>
      <button onclick="hideQRScanner()" style="background: #6c757d;">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status">
      <div id="statusText">åˆæœŸåŒ–ä¸­...</div>
    </div>
    
    <!-- ãƒãƒ¼ã‚«ãƒ¼ã‚¬ã‚¤ãƒ‰ -->
    <div id="markerGuide"></div>
    
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div id="controls">
      <h3>ğŸ“± çµ±åˆARãƒ“ãƒ¥ãƒ¼ã‚¢</h3>
      <p id="instruction">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ARãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™</p>
      <button id="scanBtn" onclick="showQRScanner()">ğŸ“± QRã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿</button>
      <button id="startArBtn" onclick="startAR()" style="display: none;">ğŸš€ ARé–‹å§‹</button>
      <button id="detectBtn" onclick="simulateMarkerDetection()" style="display: none;">ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º</button>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- GLTFLoader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/loaders/GLTFLoader.js"></script>
  
  <script>
    // DOMè¦ç´ 
    const loadingScreen = document.getElementById('loadingScreen');
    const loadingBar = document.getElementById('loadingBar');
    const loadingMessage = document.getElementById('loadingMessage');
    const qrScanner = document.getElementById('qrScanner');
    const statusEl = document.getElementById('statusText');
    const status = document.getElementById('status');
    const instructionEl = document.getElementById('instruction');
    const scanBtn = document.getElementById('scanBtn');
    const startArBtn = document.getElementById('startArBtn');
    const detectBtn = document.getElementById('detectBtn');
    const markerGuide = document.getElementById('markerGuide');
    const container = document.getElementById('container');
    const projectUrlInput = document.getElementById('projectUrlInput');
    
    // ARé–¢é€£å¤‰æ•°
    let camera, scene, renderer;
    let video, arActive = false, markerDetected = false;
    let currentProject = null;
    let arObjects = [];
    let loadedModels = [];
    let animationId;

    function updateStatus(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
      statusEl.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
      status.style.display = 'block';
    }

    function updateInstruction(text) {
      instructionEl.innerHTML = text;
    }

    function updateProgress(percent, message) {
      loadingBar.style.width = percent + '%';
      if (message) loadingMessage.textContent = message;
    }

    // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¡¨ç¤º/éè¡¨ç¤º
    function showQRScanner() {
      qrScanner.style.display = 'block';
    }

    function hideQRScanner() {
      qrScanner.style.display = 'none';
    }

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—
    function getProjectIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('src') || urlParams.get('id');
    }

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿
    async function loadSampleProject() {
      const sampleUrl = `${window.location.origin}/projects/sample/project.json`;
      projectUrlInput.value = sampleUrl;
      await loadProjectFromUrl();
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadProjectFromUrl() {
      const url = projectUrlInput.value.trim();
      if (!url) {
        alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      hideQRScanner();
      updateProgress(10, 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');

      try {
        updateStatus('ğŸ“¡ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­', 'info');
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        currentProject = await response.json();
        updateStatus('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†', 'success');
        updateProgress(30, 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ç¢ºèªä¸­...');
        
        console.log('ğŸ“ èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:', currentProject);
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢è¨­å®š
        if (currentProject.loadingScreen) {
          const ls = currentProject.loadingScreen;
          if (ls.message) {
            document.getElementById('loadingTitle').textContent = ls.message;
          }
          if (ls.backgroundColor) {
            loadingScreen.style.background = ls.backgroundColor;
          }
          if (ls.progressColor) {
            loadingBar.style.background = ls.progressColor;
          }
        }
        
        updateProgress(50, '3Dãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        // 3Dãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
        if (currentProject.models && currentProject.models.length > 0) {
          await loadModels();
        }
        
        updateProgress(80, 'ARã‚·ã‚¹ãƒ†ãƒ ã‚’æº–å‚™ä¸­...');
        await initAR();
        
        updateProgress(100, 'èª­ã¿è¾¼ã¿å®Œäº†');
        
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          updateInstruction(`
            <strong>âœ… ${currentProject.name || 'ARãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ'}èª­ã¿è¾¼ã¿å®Œäº†</strong><br>
            ARã‚’é–‹å§‹ã—ã¦ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¤œå‡ºã—ã¦ãã ã•ã„
          `);
          startArBtn.style.display = 'inline-block';
        }, 1000);
        
      } catch (error) {
        updateStatus(`âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateProgress(0, 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          showQRScanner();
        }, 2000);
      }
    }

    // 3Dãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
    async function loadModels() {
      updateStatus('ğŸ“¦ 3Dãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹', 'info');
      
      const loader = new THREE.GLTFLoader();
      loadedModels = [];
      
      for (let i = 0; i < currentProject.models.length; i++) {
        const modelInfo = currentProject.models[i];
        updateProgress(50 + (i / currentProject.models.length) * 20, `ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­: ${modelInfo.fileName}`);
        
        try {
          const gltf = await new Promise((resolve, reject) => {
            loader.load(
              modelInfo.url,
              resolve,
              (progress) => {
                const percent = Math.round((progress.loaded / progress.total) * 100);
                console.log(`ğŸ“Š ${modelInfo.fileName} èª­ã¿è¾¼ã¿é€²æ—: ${percent}%`);
              },
              reject
            );
          });
          
          loadedModels.push({
            scene: gltf.scene,
            fileName: modelInfo.fileName,
            originalInfo: modelInfo
          });
          
          updateStatus(`âœ… ${modelInfo.fileName} èª­ã¿è¾¼ã¿å®Œäº†`, 'success');
          
        } catch (error) {
          updateStatus(`âš ï¸ ${modelInfo.fileName} èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`, 'warning');
        }
      }
      
      updateStatus(`ğŸ“¦ 3Dãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº† (${loadedModels.length}å€‹)`, 'success');
    }

    // ARåˆæœŸåŒ–
    async function initAR() {
      updateStatus('ğŸ¨ ARã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­', 'info');
      
      // Three.jsåˆæœŸåŒ–
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 0, 5);
      
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      renderer.domElement.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
        pointer-events: none;
      `;
      
      container.appendChild(renderer.domElement);
      
      // ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      updateStatus('âœ… ARã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
    }

    // ARé–‹å§‹
    async function startAR() {
      startArBtn.style.display = 'none';
      
      try {
        updateStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­', 'warning');
        
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        video.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
          z-index: 1;
        `;
        
        container.appendChild(video);
        await video.play();
        
        updateStatus('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ', 'success');
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
        startRenderLoop();
        
        arActive = true;
        detectBtn.style.display = 'inline-block';
        
        updateInstruction(`
          <strong>ğŸ“± ARæº–å‚™å®Œäº†</strong><br>
          ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€å®Ÿéš›ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„
        `);
        
      } catch (error) {
        updateStatus(`âŒ ARé–‹å§‹å¤±æ•—: ${error.message}`, 'error');
      }
    }

    // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    function simulateMarkerDetection() {
      if (markerDetected) {
        // ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±
        markerDetected = false;
        arObjects.forEach(obj => scene.remove(obj));
        arObjects = [];
        markerGuide.style.display = 'none';
        
        updateStatus('âŒ ãƒãƒ¼ã‚«ãƒ¼ã‚’è¦‹å¤±ã„ã¾ã—ãŸ', 'warning');
        detectBtn.textContent = 'ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º';
        detectBtn.style.background = '#28a745';
        
      } else {
        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º
        markerDetected = true;
        createARScene();
        markerGuide.style.display = 'block';
        
        updateStatus('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæˆåŠŸï¼', 'success');
        updateInstruction(`
          <strong>ğŸ‰ ${currentProject.name || 'ARãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ'} è¡¨ç¤ºä¸­</strong><br>
          èª­ã¿è¾¼ã¾ã‚ŒãŸ3Dãƒ¢ãƒ‡ãƒ«: ${loadedModels.length}å€‹
        `);
        detectBtn.textContent = 'âŒ ãƒãƒ¼ã‚«ãƒ¼æ¶ˆå¤±';
        detectBtn.style.background = '#dc3545';
      }
    }

    // ARã‚·ãƒ¼ãƒ³ä½œæˆ
    function createARScene() {
      updateStatus('ğŸ¨ ARã‚·ãƒ¼ãƒ³æ§‹ç¯‰ä¸­', 'info');
      
      if (loadedModels.length > 0) {
        // èª­ã¿è¾¼ã¾ã‚ŒãŸ3Dãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
        loadedModels.forEach((modelData, index) => {
          const model = modelData.scene.clone();
          
          // ã‚µã‚¤ã‚ºæ­£è¦åŒ–
          const box = new THREE.Box3().setFromObject(model);
          const size = box.getSize(new THREE.Vector3());
          const maxSize = Math.max(size.x, size.y, size.z);
          const scale = 1.0 / maxSize;
          model.scale.setScalar(scale);
          
          // ä½ç½®èª¿æ•´
          model.position.set(index * 1.2 - (loadedModels.length - 1) * 0.6, 0, 0);
          
          scene.add(model);
          arObjects.push(model);
        });
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);
        arObjects.push(cube);
      }
      
      updateStatus(`âœ… ARã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®å®Œäº† (${arObjects.length}å€‹)`, 'success');
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
    function startRenderLoop() {
      function animate() {
        animationId = requestAnimationFrame(animate);
        
        if (markerDetected && arObjects.length > 0) {
          arObjects.forEach((obj, index) => {
            obj.rotation.y += 0.01 + index * 0.005;
            obj.position.y = Math.sin(Date.now() * 0.001 + index) * 0.1;
          });
        }
        
        renderer.render(scene, camera);
      }
      
      animate();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('load', () => {
      updateStatus('ğŸ“± çµ±åˆARãƒ“ãƒ¥ãƒ¼ã‚¢èµ·å‹•', 'success');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•èª­ã¿è¾¼ã¿
      const projectUrl = getProjectIdFromUrl();
      if (projectUrl) {
        projectUrlInput.value = projectUrl;
        setTimeout(loadProjectFromUrl, 1000);
      } else {
        // QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’è¡¨ç¤º
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          showQRScanner();
        }, 1500);
      }
    });

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });
  </script>
</body>
</html>