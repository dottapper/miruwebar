/**
 * ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚¨ãƒ‡ã‚£ã‚¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 */

export default function showLoadingScreenEditor(container) {
  // ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
  container.classList.add('loading-screen-editor');

  // === å®šæ•°å®šç¾© ===
  const defaultSettings = {
    backgroundColor: 'rgba(0, 0, 0, 0.85)',
    textColor: '#ffffff',
    accentColor: '#007aff',
    logo: null,
    brandName: 'miru-WebAR',
    subTitle: 'WebARã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹',
    loadingMessage: 'ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...',
    fontScale: 1.0,
    startTitle: 'ç„¡é¡Œã®AR',
    startButtonText: 'ARã‚’é–‹å§‹',
    startThumbnail: null,
  };

  const THUMBNAIL_FILE_LIMITS = {
    maxSize: 2 * 1024 * 1024,
    allowedTypes: ['image/jpeg', 'image/png'],
    maxWidth: 1920,
    maxHeight: 1080
  };

  // === å¤‰æ•°å®šç¾© ===
  let currentSettings = { ...defaultSettings };
  let logoFile = null;
  let elements = {}; // DOMè¦ç´ ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

  // === ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾© ===
  const startTabContent = `
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" class="loading-screen-editor__input" id="start-title" name="startTitle" placeholder="ç„¡é¡Œã®AR">
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">é–‹å§‹ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ</label>
      <input type="text" class="loading-screen-editor__input" id="start-button-text" name="startButtonText" placeholder="ARã‚’é–‹å§‹">
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ</label>
      <div class="loading-screen-editor__file-preview" id="start-thumbnail-preview">
        <div class="loading-screen-editor__drop-zone">
          <span class="loading-screen-editor__drop-zone-icon">ğŸ“¸</span>
          <span class="loading-screen-editor__drop-zone-text">ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</span>
          <span class="loading-screen-editor__drop-zone-subtext">ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
          <div class="loading-screen-editor__supported-formats">
            å¯¾å¿œå½¢å¼: JPG, PNG (2MBã¾ã§)
            <br>æ¨å¥¨ã‚µã‚¤ã‚º: 1280x720px
          </div>
        </div>
      </div>
      <input type="file" id="start-thumbnail-upload" accept="image/jpeg,image/png" style="display: none;">
    </div>
  `;

  const generalTabContent = `
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">èƒŒæ™¯è‰²</label>
      <div class="loading-screen-editor__color-group">
        <input type="color" class="loading-screen-editor__color-picker" id="bg-color-picker" name="backgroundColor">
        <input type="text" class="loading-screen-editor__input loading-screen-editor__color-text" id="bg-color-text" name="backgroundColorText" placeholder="rgba(0, 0, 0, 0.85)">
      </div>
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ãƒ†ã‚­ã‚¹ãƒˆè‰²</label>
      <div class="loading-screen-editor__color-group">
        <input type="color" class="loading-screen-editor__color-picker" id="text-color-picker" name="textColor">
        <input type="text" class="loading-screen-editor__input loading-screen-editor__color-text" id="text-color-text" name="textColorText" placeholder="#ffffff">
      </div>
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²</label>
      <div class="loading-screen-editor__color-group">
        <input type="color" class="loading-screen-editor__color-picker" id="accent-color-picker" name="accentColor">
        <input type="text" class="loading-screen-editor__input loading-screen-editor__color-text" id="accent-color-text" name="accentColorText" placeholder="#007aff">
      </div>
    </div>
  `;

  const textTabContent = `
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ãƒ–ãƒ©ãƒ³ãƒ‰å</label>
      <input type="text" class="loading-screen-editor__input" name="brandName" placeholder="miru-WebAR">
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input type="text" class="loading-screen-editor__input" name="subTitle" placeholder="WebARã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹">
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
      <input type="text" class="loading-screen-editor__input" name="loadingMessage" placeholder="ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...">
    </div>
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå€ç‡</label>
      <input type="range" class="loading-screen-editor__input loading-screen-editor__range" name="fontScale" min="0.5" max="2" step="0.1" value="1.0">
      <div class="loading-screen-editor__range-value">1.0x</div>
    </div>
  `;

  const animationTabContent = `
    <div class="loading-screen-editor__form-group">
      <label class="loading-screen-editor__label">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</label>
      <select class="loading-screen-editor__input loading-screen-editor__select" name="animation">
        <option value="fade">ãƒ•ã‚§ãƒ¼ãƒ‰</option>
        <option value="slide">ã‚¹ãƒ©ã‚¤ãƒ‰</option>
        <option value="zoom">ã‚ºãƒ¼ãƒ </option>
      </select>
    </div>
  `;

  // === ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾© ===
  const loadingPreviewTemplate = `
    <div class="loading-screen-editor__loading-preview">
      <div class="loading-screen-editor__logo">
        <img src="" alt="Logo" class="loading-screen-editor__logo-image" style="display: none;">
      </div>
      <div class="loading-screen-editor__preview-text loading-screen-editor__brand-name"></div>
      <div class="loading-screen-editor__preview-text loading-screen-editor__subtitle"></div>
      <div class="loading-screen-editor__progress">
        <div class="loading-screen-editor__progress-bar"></div>
      </div>
      <div class="loading-screen-editor__preview-text loading-screen-editor__loading-message"></div>
    </div>
  `;

  const startPreviewTemplate = `
    <div class="loading-screen-editor__start-preview">
      <div class="loading-screen-editor__thumbnail-wrapper">
        <img class="loading-screen-editor__thumbnail" src="" alt="ã‚µãƒ ãƒã‚¤ãƒ«">
      </div>
      <div class="loading-screen-editor__start-content">
        <div class="loading-screen-editor__preview-text loading-screen-editor__start-title"></div>
        <button class="loading-screen-editor__start-button"></button>
      </div>
    </div>
  `;

  const editorTemplate = `
    <div class="loading-screen-editor__container">
      <div class="loading-screen-editor__settings">
        <div class="loading-screen-editor__tabs" role="tablist">
          <button class="loading-screen-editor__tab loading-screen-editor__tab--active" data-tab="start" role="tab" aria-selected="true" aria-controls="start-content">
            åˆæœŸç”»é¢
          </button>
          <button class="loading-screen-editor__tab" data-tab="general" role="tab" aria-selected="false" aria-controls="general-content">
            ã‚«ãƒ©ãƒ¼è¨­å®š
          </button>
          <button class="loading-screen-editor__tab" data-tab="text" role="tab" aria-selected="false" aria-controls="text-content">
            ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
          </button>
          <button class="loading-screen-editor__tab" data-tab="animation" role="tab" aria-selected="false" aria-controls="animation-content">
            ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
          </button>
        </div>
        <div class="loading-screen-editor__tab-contents">
          <div class="loading-screen-editor__tab-content loading-screen-editor__tab-content--active" id="start-content" data-tab="start" role="tabpanel">
            ${startTabContent}
          </div>
          <div class="loading-screen-editor__tab-content" id="general-content" data-tab="general" role="tabpanel">
            ${generalTabContent}
          </div>
          <div class="loading-screen-editor__tab-content" id="text-content" data-tab="text" role="tabpanel">
            ${textTabContent}
          </div>
          <div class="loading-screen-editor__tab-content" id="animation-content" data-tab="animation" role="tabpanel">
            ${animationTabContent}
          </div>
        </div>
      </div>
      <div class="loading-screen-editor__preview">
        <div class="loading-screen-editor__preview-screen">
          <div class="loading-screen-editor__phone-frame">
            <div id="preview-content"></div>
          </div>
        </div>
      </div>
    </div>
  `;

  // === APIå®šç¾© ===
  const mockAPI = {
    async getSettings() {
      const storedSettings = localStorage.getItem('loadingScreenSettings');
      if (storedSettings) {
        try {
          console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
          return JSON.parse(storedSettings);
        } catch (e) {
          console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
        }
      }
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™');
      return { ...defaultSettings };
    },

    async saveSettings(data) {
      try {
        localStorage.setItem('loadingScreenSettings', JSON.stringify(data));
        console.log('è¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ');
        return { ...data, id: 1 };
      } catch (e) {
        console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã«å¤±æ•—:', e);
        throw e;
      }
    }
  };

  // === ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ===
  function isValidColor(strColor) {
    const s = new Option().style;
    s.color = strColor;
    return s.color !== '';
  }

  function convertToHexColor(color) {
    const s = new Option().style;
    s.color = color;
    return s.color;
  }

  function showLogoError(message, detail = '') {
    if (!elements.filePreview) return;

    const existingError = elements.filePreview.querySelector('.loading-screen-editor__error');
    if (existingError) existingError.remove();

    elements.filePreview.classList.add('loading-screen-editor__file-preview--error');

    const errorElement = document.createElement('div');
    errorElement.className = 'loading-screen-editor__error';
    errorElement.innerHTML = `
      <span class="loading-screen-editor__error-icon">âš ï¸</span>
      <div class="loading-screen-editor__error-content">
        <div class="loading-screen-editor__error-title">${message}</div>
        ${detail ? `<div class="loading-screen-editor__error-detail">${detail}</div>` : ''}
      </div>
    `;
    elements.filePreview.appendChild(errorElement);

    setTimeout(() => {
      if (errorElement.parentNode === elements.filePreview) {
        errorElement.remove();
        elements.filePreview.classList.remove('loading-screen-editor__file-preview--error');
      }
    }, 3000);
  }

  function showThumbnailError(message) {
    if (!elements.thumbnailPreview) return;

    const errorElement = document.createElement('div');
    errorElement.className = 'loading-screen-editor__error';
    errorElement.textContent = message;

    const existingError = elements.thumbnailPreview.querySelector('.loading-screen-editor__error');
    if (existingError) existingError.remove();

    elements.thumbnailPreview.classList.add('loading-screen-editor__file-preview--error');
    elements.thumbnailPreview.appendChild(errorElement);

    setTimeout(() => {
      elements.thumbnailPreview.classList.remove('loading-screen-editor__file-preview--error');
      errorElement.remove();
    }, 3000);
  }

  // === UIæ›´æ–°é–¢æ•° ===
  function updatePreviewStyles() {
    if (!elements.previewScreen) return;

    // CSSå¤‰æ•°ã‚’è¨­å®š
    const root = elements.previewScreen;
    root.style.setProperty('--background-color', currentSettings.backgroundColor);
    root.style.setProperty('--text-color', currentSettings.textColor);
    root.style.setProperty('--accent-color', currentSettings.accentColor);
    root.style.setProperty('--font-scale', currentSettings.fontScale);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
    const animationClasses = ['fade', 'slide', 'zoom'];
    animationClasses.forEach(cls => {
      root.classList.remove(`loading-screen-editor__preview--animation-${cls}`);
    });
    root.classList.add(`loading-screen-editor__preview--animation-${currentSettings.animation}`);
  }

  function updatePreview() {
    if (!elements.previewScreen) return;

    const brandName = elements.previewScreen.querySelector('.loading-screen-editor__brand-name');
    const subTitle = elements.previewScreen.querySelector('.loading-screen-editor__subtitle');
    const loadingMessage = elements.previewScreen.querySelector('.loading-screen-editor__loading-message');
    const logoImg = elements.previewScreen.querySelector('.loading-screen-editor__logo-image');

    if (brandName) brandName.textContent = currentSettings.brandName;
    if (subTitle) subTitle.textContent = currentSettings.subTitle;
    if (loadingMessage) loadingMessage.textContent = currentSettings.loadingMessage;

    if (logoImg) {
      if (currentSettings.logo) {
        logoImg.src = currentSettings.logo;
        logoImg.style.display = 'block';
      } else {
        logoImg.style.display = 'none';
      }
    }

    updatePreviewStyles();
  }

  function updateStartPreview() {
    if (!elements.previewScreen) return;

    const thumbnail = elements.previewScreen.querySelector('.loading-screen-editor__thumbnail');
    const title = elements.previewScreen.querySelector('.loading-screen-editor__start-title');
    const button = elements.previewScreen.querySelector('.loading-screen-editor__start-button');
    const thumbnailWrapper = elements.previewScreen.querySelector('.loading-screen-editor__thumbnail-wrapper');

    if (thumbnail && thumbnailWrapper) {
      if (currentSettings.startThumbnail) {
        thumbnail.src = currentSettings.startThumbnail;
        thumbnailWrapper.style.display = 'block';
      } else {
        thumbnailWrapper.style.display = 'none';
      }
    }

    if (title) title.textContent = currentSettings.startTitle || defaultSettings.startTitle;
    if (button) button.textContent = currentSettings.startButtonText || defaultSettings.startButtonText;

    updatePreviewStyles();
  }

  // === ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ ===
  function handleTabClick(event) {
    const tabButton = event.target.closest('.loading-screen-editor__tab');
    if (!tabButton) return;

    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    elements.tabButtons.forEach(btn => {
      btn.classList.remove('loading-screen-editor__tab--active');
      btn.setAttribute('aria-selected', 'false');
    });
    tabButton.classList.add('loading-screen-editor__tab--active');
    tabButton.setAttribute('aria-selected', 'true');

    // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’æ›´æ–°
    const tabName = tabButton.dataset.tab;
    elements.tabContents.forEach(content => {
      content.classList.remove('loading-screen-editor__tab-content--active');
    });

    const activeContent = container.querySelector(`.loading-screen-editor__tab-content[data-tab="${tabName}"]`);
    if (activeContent) {
      activeContent.classList.add('loading-screen-editor__tab-content--active');
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
    updatePreviewPanel(tabName);
  }

  function handleThumbnailFile(file) {
    if (!THUMBNAIL_FILE_LIMITS.allowedTypes.includes(file.type)) {
      showThumbnailError('JPEGã¾ãŸã¯PNGå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (file.size > THUMBNAIL_FILE_LIMITS.maxSize) {
      showThumbnailError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯2MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
      return;
    }

    const img = new Image();
    const reader = new FileReader();

    reader.onload = (e) => {
      img.src = e.target.result;
      img.onload = () => {
        if (img.width > THUMBNAIL_FILE_LIMITS.maxWidth || img.height > THUMBNAIL_FILE_LIMITS.maxHeight) {
          showThumbnailError(`ç”»åƒã‚µã‚¤ã‚ºã¯${THUMBNAIL_FILE_LIMITS.maxWidth}x${THUMBNAIL_FILE_LIMITS.maxHeight}pxä»¥ä¸‹ã«ã—ã¦ãã ã•ã„`);
          return;
        }

        currentSettings.startThumbnail = e.target.result;
        updateStartPreview();

        if (elements.thumbnailPreview) {
          elements.thumbnailPreview.classList.add('has-file');
          const dropZoneContent = elements.thumbnailPreview.querySelector('.drop-zone-content');
          if (dropZoneContent) {
            dropZoneContent.innerHTML = `
              <img src="${e.target.result}" alt="ã‚µãƒ ãƒã‚¤ãƒ«" style="max-height: 100px; max-width: 100%;">
              <span class="sub-text">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’å¤‰æ›´</span>
            `;
          }
        }
      };
    };

    reader.readAsDataURL(file);
  }

  // === ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•° ===
  function setupColorInputs() {
    if (!elements.backgroundColorPicker || !elements.backgroundColorText ||
        !elements.textColorPicker || !elements.textColorText ||
        !elements.accentColorPicker || !elements.accentColorText) return;

    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®åˆæœŸå€¤ã‚’è¨­å®š
    elements.backgroundColorPicker.value = convertToHexColor(currentSettings.backgroundColor);
    elements.textColorPicker.value = convertToHexColor(currentSettings.textColor);
    elements.accentColorPicker.value = convertToHexColor(currentSettings.accentColor);

    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®åˆæœŸå€¤ã‚’è¨­å®š
    elements.backgroundColorText.value = currentSettings.backgroundColor;
    elements.textColorText.value = currentSettings.textColor;
    elements.accentColorText.value = currentSettings.accentColor;

    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    const handleColorPickerChange = (picker, text, settingKey) => {
      return () => {
        const color = picker.value;
        if (isValidColor(color)) {
          text.value = color;
          currentSettings[settingKey] = color;
          updatePreviewStyles();
        }
      };
    };

    // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    const handleColorTextChange = (text, picker, settingKey) => {
      return () => {
        const color = text.value;
        if (isValidColor(color)) {
          picker.value = convertToHexColor(color);
          currentSettings[settingKey] = color;
          updatePreviewStyles();
        }
      };
    };

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    elements.backgroundColorPicker.addEventListener('input', 
      handleColorPickerChange(elements.backgroundColorPicker, elements.backgroundColorText, 'backgroundColor'));
    elements.textColorPicker.addEventListener('input',
      handleColorPickerChange(elements.textColorPicker, elements.textColorText, 'textColor'));
    elements.accentColorPicker.addEventListener('input',
      handleColorPickerChange(elements.accentColorPicker, elements.accentColorText, 'accentColor'));

    elements.backgroundColorText.addEventListener('input',
      handleColorTextChange(elements.backgroundColorText, elements.backgroundColorPicker, 'backgroundColor'));
    elements.textColorText.addEventListener('input',
      handleColorTextChange(elements.textColorText, elements.textColorPicker, 'textColor'));
    elements.accentColorText.addEventListener('input',
      handleColorTextChange(elements.accentColorText, elements.accentColorPicker, 'accentColor'));
  }

  function setupTextInputs() {
    if (!elements.brandNameInput || !elements.subTitleInput || 
        !elements.loadingMessageInput || !elements.fontScaleInput) return;

    // åˆæœŸå€¤ã‚’è¨­å®š
    elements.brandNameInput.value = currentSettings.brandName;
    elements.subTitleInput.value = currentSettings.subTitle;
    elements.loadingMessageInput.value = currentSettings.loadingMessage;
    elements.fontScaleInput.value = currentSettings.fontScale;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    elements.brandNameInput.addEventListener('input', () => {
      currentSettings.brandName = elements.brandNameInput.value;
      updatePreview();
    });

    elements.subTitleInput.addEventListener('input', () => {
      currentSettings.subTitle = elements.subTitleInput.value;
      updatePreview();
    });

    elements.loadingMessageInput.addEventListener('input', () => {
      currentSettings.loadingMessage = elements.loadingMessageInput.value;
      updatePreview();
    });

    elements.fontScaleInput.addEventListener('input', () => {
      currentSettings.fontScale = elements.fontScaleInput.value;
      updatePreviewStyles();
    });
  }

  function setupAnimationInputs() {
    if (!elements.animationSelect) return;

    // åˆæœŸå€¤ã‚’è¨­å®š
    elements.animationSelect.value = currentSettings.animation;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    elements.animationSelect.addEventListener('change', () => {
      currentSettings.animation = elements.animationSelect.value;
      updatePreviewStyles();
    });
  }

  function setupStartScreenHandlers() {
    if (!elements.titleInput || !elements.buttonTextInput || !elements.thumbnailPreview) return;

    elements.titleInput.value = currentSettings.startTitle;
    elements.buttonTextInput.value = currentSettings.startButtonText;

    elements.titleInput.addEventListener('input', (e) => {
      currentSettings.startTitle = e.target.value;
      updateStartPreview();
    });

    elements.buttonTextInput.addEventListener('input', (e) => {
      currentSettings.startButtonText = e.target.value;
      updateStartPreview();
    });

    // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ãƒœã‚¿ãƒ³ã¨ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¨­å®š
    const fileInput = document.getElementById('start-thumbnail-upload');
    if (fileInput) {
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã§éè¡¨ç¤ºã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
      elements.thumbnailPreview.addEventListener('click', () => fileInput.click());
      
      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      elements.thumbnailPreview.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        elements.thumbnailPreview.classList.add('loading-screen-editor__file-preview--dragover');
      });
      
      elements.thumbnailPreview.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        elements.thumbnailPreview.classList.remove('loading-screen-editor__file-preview--dragover');
      });
      
      elements.thumbnailPreview.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        elements.thumbnailPreview.classList.remove('loading-screen-editor__file-preview--dragover');
        const file = e.dataTransfer.files[0];
        if (file) handleThumbnailFile(file);
      });
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleThumbnailFile(file);
      });
    }
  }

  // === åˆæœŸåŒ–é–¢æ•° ===
  async function initializeEditor() {
    try {
      // ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ 
      container.innerHTML = editorTemplate;

      // DOMè¦ç´ ã®å‚ç…§ã‚’å–å¾—
      elements = {
        // ã‚¿ãƒ–é–¢é€£
        tabButtons: container.querySelectorAll('.loading-screen-editor__tab'),
        tabContents: container.querySelectorAll('.loading-screen-editor__tab-content'),
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£
        previewScreen: container.querySelector('#preview-content'),
        
        // ã‚«ãƒ©ãƒ¼å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        backgroundColorPicker: container.querySelector('#bg-color-picker'),
        backgroundColorText: container.querySelector('#bg-color-text'),
        textColorPicker: container.querySelector('#text-color-picker'),
        textColorText: container.querySelector('#text-color-text'),
        accentColorPicker: container.querySelector('#accent-color-picker'),
        accentColorText: container.querySelector('#accent-color-text'),
        
        // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        brandNameInput: container.querySelector('input[name="brandName"]'),
        subTitleInput: container.querySelector('input[name="subTitle"]'),
        loadingMessageInput: container.querySelector('input[name="loadingMessage"]'),
        fontScaleInput: container.querySelector('input[name="fontScale"]'),
        animationSelect: container.querySelector('select[name="animation"]'),
        
        // ã‚µãƒ ãƒã‚¤ãƒ«é–¢é€£
        titleInput: container.querySelector('#start-title'),
        buttonTextInput: container.querySelector('#start-button-text'),
        thumbnailPreview: container.querySelector('#start-thumbnail-preview'),
      };

      // è¨­å®šã®èª­ã¿è¾¼ã¿
      const savedSettings = await mockAPI.getSettings();
      currentSettings = { ...defaultSettings, ...savedSettings };

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
      setupColorInputs();
      setupTextInputs();
      setupAnimationInputs();
      setupStartScreenHandlers();

      // ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
      elements.tabButtons.forEach(button => {
        button.addEventListener('click', handleTabClick);
      });

      // æœ€åˆã®ã‚¿ãƒ–ã‚’é¸æŠ
      const firstTab = elements.tabButtons[0];
      if (firstTab) firstTab.click();

    } catch (error) {
      console.error('ã‚¨ãƒ‡ã‚£ã‚¿ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
  }

  // === ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«æ›´æ–°é–¢æ•° ===
  function updatePreviewPanel(tabName) {
    const previewContent = document.getElementById('preview-content');
    if (!previewContent) return;

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
    previewContent.innerHTML = '';

    if (tabName === 'start') {
      // åˆæœŸç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      previewContent.innerHTML = startPreviewTemplate;
      updateStartPreview();
    } else {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      previewContent.innerHTML = loadingPreviewTemplate;
      updatePreview();
    }

    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
    updatePreviewStyles();
  }

  // === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•° ===
  function cleanup() {
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è§£é™¤
    if (elements.tabButtons) {
      elements.tabButtons.forEach(button => {
        button.removeEventListener('click', handleTabClick);
      });
    }

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
    const inputs = container.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.removeEventListener('input', null);
      input.removeEventListener('change', null);
    });

    // è¨­å®šã®ä¿å­˜
    mockAPI.saveSettings(currentSettings).catch(error => {
      console.error('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    });

    // è¦ç´ ã®å‚ç…§ã‚’ã‚¯ãƒªã‚¢
    elements = {};
  }

  // === åˆæœŸåŒ–å‡¦ç†ã®å®Ÿè¡Œ ===
  initializeEditor();

  // === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°ã‚’è¿”ã™ ===
  return cleanup;
}