<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆ - ä¿®æ­£ç‰ˆ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    #arContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      max-width: 300px;
      font-size: 12px;
      line-height: 1.4;
    }
    
    #instructions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      z-index: 1000;
      max-width: 320px;
    }
    
    .error { color: #ff4444; }
    .success { color: #44ff44; }
    .warning { color: #ffaa44; }
    .info { color: #4488ff; }
    
    #retryBtn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    
    #retryBtn:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div id="arContainer">
    <div id="status">
      <div id="statusText">åˆæœŸåŒ–ä¸­...</div>
    </div>
    
    <div id="instructions">
      <h3>ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰</h3>
      <p>ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</p>
      <button id="retryBtn" style="display: none;" onclick="retryInitialization()">ğŸ”„ å†è©¦è¡Œ</button>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('statusText');
    const instructionsEl = document.getElementById('instructions');
    const retryBtn = document.getElementById('retryBtn');
    
    let initAttempts = 0;
    const maxAttempts = 3;
    
    function updateStatus(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
      statusEl.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
    }

    function updateInstructions(html) {
      instructionsEl.innerHTML = html;
    }

    // AR.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ®µéšçš„ã«èª­ã¿è¾¼ã¿
    async function loadARLibraries() {
      updateStatus('ğŸ“¦ Three.js ç¢ºèªä¸­...', 'info');
      
      // Three.js ã®ç¢ºèª
      if (!window.THREE) {
        updateStatus('âŒ Three.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
        throw new Error('Three.js is not loaded');
      }
      updateStatus('âœ… Three.js ç¢ºèªå®Œäº†', 'success');

      updateStatus('ğŸ“¦ AR.js èª­ã¿è¾¼ã¿é–‹å§‹...', 'info');
      
      // AR.js ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿ï¼ˆè¤‡æ•°ã®CDNã‚’è©¦è¡Œï¼‰
      const arjsUrls = [
        'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threex.js',
        'https://unpkg.com/@ar-js-org/ar.js@3.4.5/three.js/build/ar-threex.js',
        'https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.5/three.js/build/ar-threex.js'
      ];

      for (const url of arjsUrls) {
        try {
          updateStatus(`ğŸ“¥ AR.js èª­ã¿è¾¼ã¿è©¦è¡Œ: ${url.split('/')[2]}`, 'info');
          await loadScript(url);
          
          if (window.THREEx && window.THREEx.ArToolkitSource) {
            updateStatus('âœ… AR.js èª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
            return;
          }
        } catch (error) {
          updateStatus(`âš ï¸ CDNå¤±æ•—: ${url.split('/')[2]}`, 'warning');
          continue;
        }
      }

      throw new Error('ã™ã¹ã¦ã®AR.js CDNã§èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        // æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const existing = document.querySelector(`script[src="${src}"]`);
        if (existing) {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          updateStatus(`âœ… ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†: ${src.split('/').pop()}`, 'success');
          resolve();
        };
        script.onerror = () => {
          updateStatus(`âŒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—: ${src.split('/').pop()}`, 'error');
          reject(new Error(`Failed to load script: ${src}`));
        };
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        setTimeout(() => {
          script.onerror = null;
          script.onload = null;
          reject(new Error(`Script load timeout: ${src}`));
        }, 10000);
        
        document.head.appendChild(script);
      });
    }

    // ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
    async function initMarkerAR() {
      initAttempts++;
      updateStatus(`ğŸš€ ãƒãƒ¼ã‚«ãƒ¼ARåˆæœŸåŒ–é–‹å§‹ (è©¦è¡Œ ${initAttempts}/${maxAttempts})`, 'info');
      
      try {
        // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿
        await loadARLibraries();
        
        // ã‚¹ãƒ†ãƒƒãƒ—2: Three.js åŸºæœ¬è¨­å®š
        updateStatus('ğŸ¨ Three.js è¨­å®šä¸­...', 'info');
        const scene = new THREE.Scene();
        const camera = new THREE.Camera();
        const renderer = new THREE.WebGLRenderer({ 
          antialias: true, 
          alpha: true,
          powerPreference: "default"
        });

        const container = document.getElementById('arContainer');
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0px';
        renderer.domElement.style.left = '0px';
        container.appendChild(renderer.domElement);
        updateStatus('âœ… Three.js ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼æº–å‚™å®Œäº†', 'success');

        // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚«ãƒ¡ãƒ©ã‚½ãƒ¼ã‚¹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçŸ­ç¸®ï¼‰
        updateStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹é–‹å§‹...', 'warning');
        const arToolkitSource = new THREEx.ArToolkitSource({
          sourceType: 'webcam',
          sourceWidth: 480,
          sourceHeight: 640,
          displayWidth: 480,
          displayHeight: 640
        });

        await new Promise((resolve, reject) => {
          let cameraTimeout = setTimeout(() => {
            reject(new Error('ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’ï¼‰'));
          }, 5000);

          arToolkitSource.init(
            () => {
              clearTimeout(cameraTimeout);
              updateStatus('âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', 'success');
              arToolkitSource.onResize();
              arToolkitSource.copySizeTo(renderer.domElement);
              resolve();
            },
            (error) => {
              clearTimeout(cameraTimeout);
              reject(error);
            }
          );
        });

        // ã‚¹ãƒ†ãƒƒãƒ—4: ARã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçŸ­ç¸®ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        updateStatus('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–...', 'warning');
        // ã‚¢ã‚»ãƒƒãƒˆURLè§£æ±ºï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆã€å¤±æ•—æ™‚ã¯CDN/Rawï¼‰
        const cameraParametersUrl = await (async () => {
          const candidates = [
            '/arjs/camera_para.dat',
            'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/data/camera_para.dat',
            'https://unpkg.com/@ar-js-org/ar.js@3.4.5/three.js/data/camera_para.dat',
            'https://raw.githubusercontent.com/artoolkitx/jsartoolkit5/master/examples/Three.js/data/camera_para.dat'
          ];
          for (const url of candidates) {
            try {
              const res = await fetch(url, { cache: 'no-store' });
              if (!res.ok) continue;
              const buf = await res.clone().arrayBuffer();
              if (buf.byteLength >= 1024) {
                const head = new TextDecoder().decode(new Uint8Array(buf).slice(0, 256)).toLowerCase();
                if (!head.includes("couldn't find the requested file") && !head.includes('<html') && !head.includes('not found')) return url;
              }
            } catch {}
          }
          return candidates[0];
        })();

        const arToolkitContext = new THREEx.ArToolkitContext({
          cameraParametersUrl: cameraParametersUrl,
          detectionMode: 'mono',
          matrixCodeType: '3x3',
          canvasWidth: 480,
          canvasHeight: 640,
          maxDetectionRate: 30
        });

        await new Promise((resolve, reject) => {
          let contextTimeout = setTimeout(() => {
            reject(new Error('ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’ï¼‰'));
          }, 5000);

          try {
            arToolkitContext.init(() => {
              clearTimeout(contextTimeout);
              camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
              updateStatus('âœ… ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
              resolve();
            });
          } catch (error) {
            clearTimeout(contextTimeout);
            reject(error);
          }
        });

        // ã‚¹ãƒ†ãƒƒãƒ—5: ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        updateStatus('ğŸ® ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š...', 'info');
        const markerRoot = new THREE.Group();
        scene.add(markerRoot);

        const markerControls = new THREEx.ArMarkerControls(
          arToolkitContext, 
          markerRoot, 
          {
            type: 'pattern',
            patternUrl: await (async () => {
              const candidates = [
                '/arjs/patt.hiro',
                'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/data/patt.hiro',
                'https://unpkg.com/@ar-js-org/ar.js@3.4.5/three.js/data/patt.hiro',
                'https://raw.githubusercontent.com/artoolkitx/jsartoolkit5/master/examples/Three.js/data/patt.hiro'
              ];
              for (const url of candidates) {
                try {
                  const res = await fetch(url, { cache: 'no-store' });
                  if (!res.ok) continue;
                  const buf = await res.clone().arrayBuffer();
                  if (buf.byteLength >= 256) {
                    const head = new TextDecoder().decode(new Uint8Array(buf).slice(0, 256)).toLowerCase();
                    if (!head.includes("couldn't find the requested file") && !head.includes('<html') && !head.includes('not found')) return url;
                  }
                } catch {}
              }
              return candidates[0];
            })()
          }
        );

        // ãƒ†ã‚¹ãƒˆç”¨3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.y = 0.4;
        markerRoot.add(cube);

        const sphereGeometry = new THREE.SphereGeometry(0.2, 16, 16);
        const sphereMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.set(0, 1.2, 0);
        markerRoot.add(sphere);

        // ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        updateStatus('âœ… 3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…ç½®å®Œäº†', 'success');

        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºç›£è¦–
        let lastMarkerVisible = false;
        setInterval(() => {
          const isVisible = markerRoot.visible;
          if (isVisible !== lastMarkerVisible) {
            if (isVisible) {
              updateStatus('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæˆåŠŸï¼ç·‘ã®ã‚­ãƒ¥ãƒ¼ãƒ–ã¨èµ¤ã„çƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™', 'success');
              updateInstructions(`
                <h3>ğŸ‰ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæˆåŠŸï¼</h3>
                <p>âœ… ç·‘ã®ã‚­ãƒ¥ãƒ¼ãƒ–ã¨èµ¤ã„çƒãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™</p>
                <p>ğŸ¯ HIROãƒãƒ¼ã‚«ãƒ¼ã‚’å‹•ã‹ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„</p>
              `);
            } else {
              updateStatus('âš ï¸ ãƒãƒ¼ã‚«ãƒ¼ã‚’è¦‹å¤±ã„ã¾ã—ãŸ', 'warning');
              updateInstructions(`
                <h3>ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆ</h3>
                <p>HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
                <p>è·é›¢: 20-40cm / æ­£é¢ã‹ã‚‰è¦‹ã‚‹</p>
              `);
            }
            lastMarkerVisible = isVisible;
          }
        }, 200);

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
          requestAnimationFrame(animate);
          
          if (arToolkitSource.ready) {
            arToolkitContext.update(arToolkitSource.domElement);
          }
          
          if (markerRoot.visible) {
            cube.rotation.x += 0.02;
            cube.rotation.y += 0.02;
            sphere.position.y = 1.2 + Math.sin(Date.now() * 0.005) * 0.2;
          }
          
          renderer.render(scene, camera);
        }

        animate();
        updateStatus('ğŸš€ ãƒãƒ¼ã‚«ãƒ¼ARåˆæœŸåŒ–å®Œäº†ï¼', 'success');
        updateInstructions(`
          <h3>ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆ</h3>
          <p>HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„</p>
          <p><a href="https://192.168.0.121:3000/hiro-marker-display.html" target="_blank" style="color: #4CAF50;">ãƒãƒ¼ã‚«ãƒ¼ã‚’åˆ¥ç«¯æœ«ã§è¡¨ç¤º</a></p>
        `);

      } catch (error) {
        updateStatus(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        
        if (initAttempts < maxAttempts) {
          retryBtn.style.display = 'inline-block';
          updateInstructions(`
            <h3>âŒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
            <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
            <p>è©¦è¡Œå›æ•°: ${initAttempts}/${maxAttempts}</p>
            <button id="retryBtn" onclick="retryInitialization()">ğŸ”„ å†è©¦è¡Œ</button>
          `);
        } else {
          updateInstructions(`
            <h3>âŒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
            <p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
            <p>ã™ã¹ã¦ã®è©¦è¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>
            <button onclick="location.reload()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px;">ğŸ”„ ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿</button>
          `);
        }
      }
    }

    function retryInitialization() {
      retryBtn.style.display = 'none';
      updateInstructions(`
        <h3>ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰</h3>
        <p>å†è©¦è¡Œä¸­...</p>
      `);
      setTimeout(initMarkerAR, 1000);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«åˆæœŸåŒ–
    window.addEventListener('load', () => {
      updateStatus('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€‚åˆæœŸåŒ–é–‹å§‹...', 'info');
      setTimeout(initMarkerAR, 500);
    });
  </script>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</body>
</html>
