<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆ - æ”¹è‰¯ç‰ˆ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    
    #arContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    
    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 1000;
      max-width: 280px;
      font-size: 11px;
      line-height: 1.3;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    
    #instructions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      padding: 12px 16px;
      border-radius: 12px;
      text-align: center;
      z-index: 1000;
      max-width: 300px;
      font-size: 13px;
    }
    
    #markerImage {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 80px;
      height: 80px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      background: white;
      z-index: 1000;
      object-fit: cover;
    }
    
    .error {
      color: #ff4444;
    }
    
    .success {
      color: #44ff44;
    }
    
    .warning {
      color: #ffaa44;
    }
    
    .info {
      color: #4488ff;
    }
    
    #debugInfo {
      position: absolute;
      top: 120px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 8px;
      border-radius: 4px;
      font-size: 10px;
      z-index: 1000;
      color: #ccc;
      max-width: 250px;
    }
  </style>
</head>
<body>
  <div id="arContainer">
    <div id="status">
      <div id="statusText">åˆæœŸåŒ–ä¸­...</div>
    </div>
    
    <div id="debugInfo">
      <div id="debugText">ãƒ‡ãƒãƒƒã‚°æƒ…å ±èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <img id="markerImage" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="HIROãƒãƒ¼ã‚«ãƒ¼" style="display: none;">
    
    <div id="instructions">
      <h3>ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼ARãƒ†ã‚¹ãƒˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰</h3>
      <p>å³ä¸Šã®ç”»åƒã‚’ã‚¹ãƒãƒ›ã§è¡¨ç¤ºã—ã€<br>ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã£ã¦ãã ã•ã„</p>
      <button onclick="downloadMarker()" style="background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin-top: 8px; cursor: pointer;">
        ğŸ“± ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </button>
    </div>
  </div>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/build/ar-threex.js"></script>

  <script>
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨
    const statusEl = document.getElementById('statusText');
    const debugEl = document.getElementById('debugText');
    const markerImg = document.getElementById('markerImage');
    
    function updateStatus(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
      statusEl.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
    }
    
    function updateDebug(info) {
      debugEl.innerHTML = Object.entries(info)
        .map(([key, value]) => `${key}: ${value}`)
        .join('<br>');
    }

    // HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
    function downloadMarker() {
      const link = document.createElement('a');
      link.href = 'https://ar-js-org.github.io/AR.js/data/images/HIRO.jpg';
      link.download = 'HIRO-marker.jpg';
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      updateStatus('ğŸ“± ãƒãƒ¼ã‚«ãƒ¼ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
    }

    // ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°
    async function initMarkerAR() {
      updateStatus('ğŸš€ ãƒãƒ¼ã‚«ãƒ¼ARåˆæœŸåŒ–é–‹å§‹...', 'info');
      
      // ç’°å¢ƒæƒ…å ±ã‚’è¡¨ç¤º
      updateDebug({
        'ãƒ–ãƒ©ã‚¦ã‚¶': navigator.userAgent.split(' ').pop(),
        'ãƒ—ãƒ­ãƒˆã‚³ãƒ«': location.protocol,
        'ãƒ›ã‚¹ãƒˆ': location.host,
        'ã‚«ãƒ¡ãƒ©API': !!navigator.mediaDevices ? 'âœ…' : 'âŒ',
        'HTTPS': location.protocol === 'https:' ? 'âœ…' : 'âŒ'
      });
      
      try {
        // AR.js ã®èª­ã¿è¾¼ã¿ç¢ºèª
        if (!window.THREEx || !window.THREEx.ArToolkitSource) {
          throw new Error('AR.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        updateStatus('âœ… AR.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªå®Œäº†', 'success');

        // HIROãƒãƒ¼ã‚«ãƒ¼ç”»åƒã‚’è¡¨ç¤º
        markerImg.src = 'https://ar-js-org.github.io/AR.js/data/images/HIRO.jpg';
        markerImg.style.display = 'block';
        markerImg.onerror = () => {
          updateStatus('âš ï¸ ãƒãƒ¼ã‚«ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œï¼‰', 'warning');
        };

        // Three.js åŸºæœ¬è¦ç´ 
        const scene = new THREE.Scene();
        const camera = new THREE.Camera();
        const renderer = new THREE.WebGLRenderer({ 
          antialias: true, 
          alpha: true,
          powerPreference: "default"
        });

        const container = document.getElementById('arContainer');
        const containerWidth = window.innerWidth;
        const containerHeight = window.innerHeight;
        
        renderer.setSize(containerWidth, containerHeight);
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0px';
        renderer.domElement.style.left = '0px';
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–
        container.appendChild(renderer.domElement);

        updateStatus('âœ… Three.js ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®šå®Œäº†', 'success');
        updateDebug({
          'ç”»é¢ã‚µã‚¤ã‚º': `${containerWidth}x${containerHeight}`,
          'ãƒ”ã‚¯ã‚»ãƒ«æ¯”': window.devicePixelRatio,
          'WebGL': renderer.capabilities.isWebGL2 ? 'WebGL2' : 'WebGL1'
        });

        // AR.js ã‚«ãƒ¡ãƒ©ã‚½ãƒ¼ã‚¹ï¼ˆãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼‰
        const arToolkitSource = new THREEx.ArToolkitSource({
          sourceType: 'webcam',
          sourceWidth: 480,  // è§£åƒåº¦ã‚’ä¸‹ã’ã¦å®‰å®šæ€§å‘ä¸Š
          sourceHeight: 640,
          displayWidth: 480,
          displayHeight: 640,
          facingMode: 'environment' // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
        });

        updateStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è¦æ±‚ä¸­...', 'warning');

        // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        await new Promise((resolve, reject) => {
          let initTimeout = setTimeout(() => {
            reject(new Error('ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰'));
          }, 10000);

          arToolkitSource.init(
            () => {
              clearTimeout(initTimeout);
              updateStatus('âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', 'success');
              
              // ã‚«ãƒ¡ãƒ©æƒ…å ±ã‚’å–å¾—
              const video = arToolkitSource.domElement;
              updateDebug({
                'ã‚«ãƒ¡ãƒ©è§£åƒåº¦': `${video.videoWidth}x${video.videoHeight}`,
                'ã‚«ãƒ¡ãƒ©æº–å‚™': video.readyState >= 2 ? 'âœ…' : 'â³',
                'ã‚¹ãƒˆãƒªãƒ¼ãƒ ': video.srcObject ? 'âœ…' : 'âŒ'
              });
              
              arToolkitSource.onResize();
              arToolkitSource.copySizeTo(renderer.domElement);
              resolve();
            },
            (error) => {
              clearTimeout(initTimeout);
              updateStatus(`âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${error.message}`, 'error');
              
              // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
              let errorDetail = '';
              if (error.name === 'NotAllowedError') {
                errorDetail = 'ã‚«ãƒ¡ãƒ©æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
              } else if (error.name === 'NotFoundError') {
                errorDetail = 'ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
              } else if (error.name === 'NotSupportedError') {
                errorDetail = 'ã‚«ãƒ¡ãƒ©ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚HTTPSæ¥ç¶šã‚’è©¦ã—ã¦ãã ã•ã„ã€‚';
              } else {
                errorDetail = `è©³ç´°: ${error.message}`;
              }
              
              updateDebug({
                'ã‚¨ãƒ©ãƒ¼å': error.name || 'Unknown',
                'ã‚¨ãƒ©ãƒ¼è©³ç´°': errorDetail
              });
              
              reject(error);
            }
          );
        });

        // AR.js ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ¤œå‡ºç²¾åº¦å‘ä¸Šï¼‰
        const arToolkitContext = new THREEx.ArToolkitContext({
          cameraParametersUrl: await (async () => {
            const candidates = [
              '/arjs/camera_para.dat',
              'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/data/camera_para.dat',
              'https://unpkg.com/@ar-js-org/ar.js@3.4.5/three.js/data/camera_para.dat',
              'https://raw.githubusercontent.com/artoolkitx/jsartoolkit5/master/examples/Three.js/data/camera_para.dat'
            ];
            for (const url of candidates) {
              try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) continue;
                const buf = await res.clone().arrayBuffer();
                if (buf.byteLength >= 1024) {
                  const head = new TextDecoder().decode(new Uint8Array(buf).slice(0, 256)).toLowerCase();
                  if (!head.includes("couldn't find the requested file") && !head.includes('<html') && !head.includes('not found')) return url;
                }
              } catch {}
            }
            return candidates[0];
          })(),
          detectionMode: 'mono',
          matrixCodeType: '3x3',
          canvasWidth: 480,
          canvasHeight: 640,
          maxDetectionRate: 60,  // æ¤œå‡ºãƒ¬ãƒ¼ãƒˆå‘ä¸Š
          imageSmoothingEnabled: true
        });

        updateStatus('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'warning');

        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆæœŸåŒ–
        await new Promise((resolve, reject) => {
          let contextTimeout = setTimeout(() => {
            reject(new Error('ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'));
          }, 8000);

          arToolkitContext.init(() => {
            clearTimeout(contextTimeout);
            camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            updateStatus('âœ… ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
            resolve();
          });
        });

        // ãƒãƒ¼ã‚«ãƒ¼ãƒ«ãƒ¼ãƒˆ
        const markerRoot = new THREE.Group();
        scene.add(markerRoot);

        // ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæ¤œå‡ºç²¾åº¦å‘ä¸Šï¼‰
        const markerControls = new THREEx.ArMarkerControls(
          arToolkitContext, 
          markerRoot, 
          {
            type: 'pattern',
            patternUrl: await (async () => {
              const candidates = [
                '/arjs/patt.hiro',
                'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/data/patt.hiro',
                'https://unpkg.com/@ar-js-org/ar.js@3.4.5/three.js/data/patt.hiro',
                'https://raw.githubusercontent.com/artoolkitx/jsartoolkit5/master/examples/Three.js/data/patt.hiro'
              ];
              for (const url of candidates) {
                try {
                  const res = await fetch(url, { cache: 'no-store' });
                  if (!res.ok) continue;
                  const buf = await res.clone().arrayBuffer();
                  if (buf.byteLength >= 256) {
                    const head = new TextDecoder().decode(new Uint8Array(buf).slice(0, 256)).toLowerCase();
                    if (!head.includes("couldn't find the requested file") && !head.includes('<html') && !head.includes('not found')) return url;
                  }
                } catch {}
              }
              return candidates[0];
            })(),
            changeMatrixMode: 'cameraTransformMatrix',
            minConfidence: 0.6  // ä¿¡é ¼åº¦é–¾å€¤ã‚’è¨­å®š
          }
        );

        // ãƒ†ã‚¹ãƒˆç”¨3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«ï¼‰
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const material = new THREE.MeshLambertMaterial({ 
          color: 0x00ff00,
          transparent: true,
          opacity: 0.9
        });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.y = 0.4;
        markerRoot.add(cube);

        // è¿½åŠ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ãï¼‰
        const sphereGeometry = new THREE.SphereGeometry(0.2, 16, 16);
        const sphereMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.set(0, 1.2, 0);
        markerRoot.add(sphere);

        // ãƒ©ã‚¤ãƒˆï¼ˆã‚ˆã‚Šæ˜ã‚‹ãï¼‰
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        updateStatus('âœ… 3Dè¦ç´ é…ç½®å®Œäº†', 'success');

        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºçŠ¶æ…‹ç›£è¦–ï¼ˆè©³ç´°æƒ…å ±ä»˜ãï¼‰
        let lastMarkerVisible = false;
        let detectionCount = 0;
        let totalFrames = 0;
        
        setInterval(() => {
          totalFrames++;
          const isVisible = markerRoot.visible;
          
          if (isVisible) {
            detectionCount++;
          }
          
          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
          const detectionRate = totalFrames > 0 ? Math.round((detectionCount / totalFrames) * 100) : 0;
          updateDebug({
            'ãƒãƒ¼ã‚«ãƒ¼çŠ¶æ…‹': isVisible ? 'ğŸ¯ æ¤œå‡ºä¸­' : 'âŒ æœªæ¤œå‡º',
            'æ¤œå‡ºãƒ•ãƒ¬ãƒ¼ãƒ ': `${detectionCount}/${totalFrames}`,
            'æ¤œå‡ºç‡': `${detectionRate}%`,
            'ã‚«ãƒ¡ãƒ©çŠ¶æ…‹': arToolkitSource.ready ? 'âœ… æº–å‚™å®Œäº†' : 'â³ æº–å‚™ä¸­'
          });
          
          if (isVisible !== lastMarkerVisible) {
            if (isVisible) {
              updateStatus('ğŸ¯ ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡ºæˆåŠŸï¼ç·‘ã®ã‚­ãƒ¥ãƒ¼ãƒ–ã¨èµ¤ã„çƒãŒè¡¨ç¤ºä¸­', 'success');
            } else {
              updateStatus('âš ï¸ ãƒãƒ¼ã‚«ãƒ¼ã‚’è¦‹å¤±ã„ã¾ã—ãŸã€‚ãƒãƒ¼ã‚«ãƒ¼ã‚’å†åº¦å‘ã‘ã¦ãã ã•ã„', 'warning');
            }
            lastMarkerVisible = isVisible;
          }
        }, 200); // 200msé–“éš”ã§æ›´æ–°

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
          requestAnimationFrame(animate);
          
          if (arToolkitSource.ready) {
            arToolkitContext.update(arToolkitSource.domElement);
          }
          
          // 3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«ï¼‰
          if (markerRoot.visible) {
            cube.rotation.x += 0.02;
            cube.rotation.y += 0.02;
            sphere.position.y = 1.2 + Math.sin(Date.now() * 0.005) * 0.2;
          }
          
          renderer.render(scene, camera);
        }

        animate();
        updateStatus('ğŸš€ ãƒãƒ¼ã‚«ãƒ¼ARé–‹å§‹å®Œäº†ï¼HIROãƒãƒ¼ã‚«ãƒ¼ã‚’å‘ã‘ã¦ãã ã•ã„', 'success');

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
          const newWidth = window.innerWidth;
          const newHeight = window.innerHeight;
          
          renderer.setSize(newWidth, newHeight);
          if (arToolkitSource) {
            arToolkitSource.onResize();
            arToolkitSource.copySizeTo(renderer.domElement);
            if (arToolkitContext.arController) {
              arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
            }
          }
        });

      } catch (error) {
        updateStatus(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        console.error('MarkerAR Error:', error);
        
        updateDebug({
          'ã‚¨ãƒ©ãƒ¼': error.name || 'Unknown',
          'è©³ç´°': error.message,
          'ã‚¹ã‚¿ãƒƒã‚¯': error.stack ? 'ç¢ºèªå¯èƒ½' : 'ãªã—'
        });
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
    window.addEventListener('load', () => {
      updateStatus('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€‚åˆæœŸåŒ–é–‹å§‹ã¾ã§1ç§’å¾…æ©Ÿ...', 'info');
      setTimeout(initMarkerAR, 1000);
    });
  </script>
</body>
</html>
