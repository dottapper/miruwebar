2025.8.28 更新版（実用優先・短期プランを先頭に追記）

## 直近（1–2日）実用優先プラン

目的: 「制作 → 保存 → QR → 実機AR」までを“毎回成功”させる。大規模リファクタは一旦後回しにし、最小の差分で安定化。

### A. マーカーARの安定化（最優先）
- [済] AR.jsの読み込み順修正（global THREE r122 → AR.js）と静的import化
- [済] `camera_para.dat`/`patt.hiro`の取得先をローカル優先→CDNフォールバック（2sタイムアウト）
- [要作業] `public/arjs/` に `camera_para.dat` / `patt.hiro` を配置（手動）
  - 配信パス: `/arjs/camera_para.dat`, `/arjs/patt.hiro`
- [検討] エディタに「カスタム.pattの指定」入力欄（`markerUrl`）を追加し、保存時に `project.json` へ含める

### B. ローディング画面の反映
- [済] `loadingScreen` 詳細（背景/テキスト/進捗色、メッセージ、ロゴ、表示フラグ）の保存対応
- [要作業] viewer側の反映を網羅（ロゴ、showProgress=false時のバー非表示、accentColor↔progressColorの互換）

### C. QR → 実機配信の安定化
- [済] `POST /api/publish-project`（Vite/Node両方）で `/projects/<id>/project.json+GLB` を生成
- [済] QRモーダルでIndexedDB→Base64化→自動公開→返却URLでQR生成
- [要作業] 「公開用URL」の文言整理と“ブラウザで開く”誘導、iOS/Androidの権限Tipsの表示
- [要作業] IP検出が失敗した場合のフォールバック文言（`localhost`時は“同一端末のみ”など）

### D. ViewerのUX/ガード
- [済] 「AR開始」ボタンでユーザー操作後にのみカメラ起動（自動開始撤去）
- [要作業] マーカー型では「スキャンガイド（ガイド枠/明るさ案内）」の常時表示を微改善
- [要作業] 失敗時の再試行UI（権限/HTTPS/ネットワーク/アセット404の案内ボタン）

### E. ドキュメント/運用
- [済] `public/arjs/README.txt` を追加（ローカル配置手順）
- [要作業] READMEに「起動/QR/実機テスト手順（HTTPS・証明書許可・WebView回避）」を簡潔に追記

受け入れ基準（本プランのDone）
- マーカー/マーカーレスの両方で、PC→QR→スマホAR表示が連続3回成功
- ローディング画面のメッセージ/色/ロゴが `project.json` → viewer へ反映
- 404や権限失敗時にユーザーが自力復帰できるUIがある

---

### 目的

- 3D 保存/復元の安定化、ローディング画面の永続化、QR 閲覧（スマホ）まで一連の体験を“確実に”動作させる。
- アーキテクチャの複雑さを解消し、保守性と開発効率を向上させる。

### 現状分析（コード網羅調査に基づく）

- **アーキテクチャ問題**: 巨大ファイル（editor.js 2793 行）、ストレージ混在（IndexedDB + localStorage）、複雑な vite 設定
- **保存システム不安定**: `projects-new.js`と`projects.js`の並行使用による競合
- **ローディング画面永続化失敗**: 設定保存の不整合
- **QR コード表示問題**: スマホでのネットワーク/HTTPS 問題

### 参考: 中期プラン（アーキテクチャ優先 → 機能安定化の順）

#### Phase 1: アーキテクチャ整理（1-2 日）

1. **巨大ファイル分割（優先度: 高）**

   - `editor.js` (2793 行) を以下の 4 ファイルに分割:
     - `editor-core.js`: メインエディタ初期化・ルーティング
     - `editor-models.js`: 3D モデル管理・アップロード
     - `editor-ui.js`: UI 構築・イベントハンドリング
     - `editor-save.js`: 保存・読み込み処理
   - `arViewer.js` (1727 行) を分割: コア機能・UI・設定
   - `event-handlers.js` (2067 行) を分割: 各機能別ハンドラー

2. **ストレージシステム統一（優先度: 高）**

   - `projects-new.js`と`projects.js`を統合し単一 API に
   - IndexedDB 専用ストレージアダプタ作成
   - 既存 localStorage データの移行処理実装
   - マイグレーションエラーハンドリング強化

3. **ビルド設定簡素化（優先度: 中）**
   - `vite.config.js`の不要なミドルウェア整理
   - チャンク分割設定の見直し
   - 開発サーバー設定の最適化

#### Phase 2: 機能安定化（2-3 日）

4. **保存・復元安定化（優先度: 高）**

   - 3D オブジェクトの保存失敗問題解決
   - モデルデータの整合性チェック強化
   - エラーハンドリング統一

5. **ローディング画面永続化（優先度: 高）**

   - ローディング画面設定の保存形式統一
   - プロジェクト JSON への設定統合
   - 選択状態の復元処理改善

6. **QR コード・ビューア安定化（優先度: 高）**
   - スマホでの表示問題解決
   - HTTPS/Network 設定の自動診断
   - エラーメッセージのユーザーフレンドリー化

#### Phase 3: 品質向上・最適化（1-2 日）

7. **コード品質向上（優先度: 中）**

   - グローバル汚染除去（window.loadQRCode など）
   - デバッグコード整理（LocatorJS 関連）
   - エラーハンドリング統一
   - JSDoc コメント追加

8. **パフォーマンス最適化（優先度: 中）**
   - Three.js リソース管理徹底
   - メモリリーク防止
   - バンドルサイズ最適化
   - 60fps 維持

#### Phase 4: 運用・公開機能（1-2 日）

9. **公開・エクスポート機能（優先度: 中）**

   - Export ZIP 機能の完成
   - QR コード生成 UI の改善
   - CORS・HTTPS 対応強化

10. **ドキュメント・運用補助（優先度: 低）**
    - README 更新
    - トラブルシューティングガイド拡充
    - 診断ページ整備

### 技術的考慮事項

- **互換性維持**: 既存プロジェクトデータの読み込み保証
- **段階的移行**: 各 Phase で動作検証を実施
- **テスト強化**: 保存・復元・QR 表示の自動テスト追加
- **ロールバック準備**: 各 Phase 開始前にバックアップ計画

### 成功基準

- 保存/復元成功率: 100% (現在: 不安定)
- QR コードスマホ表示: 毎回成功
- ローディング画面設定: 保存・復元正常
- コード保守性: ファイルサイズ平均 500 行以下

### 開始アプローチ

まずは本ドキュメント先頭の「直近（1–2日）実用優先プラン」を完了させ、その後に本章の中期プランへ段階的に移行します。各段階で動作検証を行い、影響を最小化します。
