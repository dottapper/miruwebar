2025-08-29 改訂版（ドキュメント統一後の修正案）

目的: 「制作 → 保存 → QR → 実機AR」を高確度に成功させるため、運用・実装の分散を解消し、不具合・混乱源を段階的に削減する。

## 直近（1–2日）実用優先タスク

1) サーバー/API の一本化（開発時）
- 開発は Vite のみを正とする（`npm run dev`）。
- `vite/plugins/*` の API を基準仕様とし、`server/simple-server.js`/`server/app.js` はレガシー扱い（README 反映済み）。
- UI 文言を見直し、「公開URL/同一端末のみ/HTTPS必須」の案内を強化。

2) QR → 実機配信の体験強化
- `network-info` が `localhost` のときの警告を表示（同一端末のみアクセス可）。
- HTTPS アクセスのガイド（自己署名証明書の許可手順）を UI から参照可能に。

3) Viewer のローディング設定反映の網羅
- `loadingScreen` の下記項目を viewer で確実に反映（現状の不足分を補う）。
  - 背景色、テキスト色、進捗色（`accentColor` 互換含む）、メッセージ、ロゴ表示、`showProgress=false` 時のバー非表示。

3.1) ローディング画面設定のエクスポート/インポート機能（完了済み）
- 📤 エクスポートボタン：設定をJSONファイルでダウンロード
- 📥 インポートボタン：JSONファイルから設定を読み込み
- IP間同期：同一端末・同一ブラウザ内でのIPアドレス変更対応
- 端末間移行：エクスポート/インポートによる設定共有（自宅↔会社対応）

4) ドキュメント整備の最小完了
- README（統一ルール、サーバー構成、標準手順、トラブルシュート）更新済み。
- README にデータ保存仕様（IndexedDB/localStorage/エクスポート）を詳細追記済み。
- `docs/routes.md` に `#/viewer`, `#/usage-guide` を追記済み。
- CONTRIBUTING にドキュメント同期ルールを追記済み。

4.1) 使い方ページへの追加予定内容
**端末間移行ワークフロー（自宅↔会社対応）:**

自宅での作業終了時：
1. ローディング画面設定を編集・保存
2. 📤 エクスポートボタンでJSONファイルダウンロード
3. ファイルをUSB/クラウドストレージに保存

会社での作業開始時：
1. miruwebar.com にアクセス
2. 📥 インポートボタンでJSONファイル選択
3. 設定が復元され、続きから作業可能

**対応状況:**
- ✅ 同一端末・同一ブラウザ：IP間自動同期
- ✅ 異なる端末・ブラウザ：エクスポート/インポート
- ⏳ 将来：プロジェクト保存時にローディング画面設定も含める予定

受け入れ基準
- マーカー/マーカーレス双方で「PC→QR→スマホ viewer 表示」が連続 3 回成功。
- `loadingScreen` の各設定が `project.json → viewer` へ期待通り反映。
- `localhost`/HTTP などの落とし穴で、ユーザーが UI 上の案内だけで復帰可能。

---

## 中期（3–5日）コード/運用の整理

5) 重複実装の段階的解消
- `server/simple-server.js` と `vite/plugins/projectsApi.js` の仕様乖離を洗い出し、1 つに集約する設計 ADR を作成。
- 開発: Vite のみ／配布: `npm run start` の二系統方針を README に確定（済）。

6) セキュリティ/堅牢化
- `publish-project`/`save` のリクエストサイズ上限（例: 10–20MB）を設定し、過大投稿を防止。
- CORS の緩すぎる `*` を縮小（ローカル開発では許容、本番/配布時は同一オリジン）。
- Express 利用時は `helmet` を有効化、`morgan` で最低限のアクセスログ。

7) ビルド設定の安定化
- `vite.config.js` の `Date.now()` 付与でビルドが非決定になる点を解消（キャッシュ制御はハッシュで十分）。
- `optimizeDeps.force: true` を常時ではなく必要時に限定。

8) ログ/デバッグの整理
- 主要箇所以外の `console.log` を `DEBUG` フラグで抑制し、本番ビルドでは除去。
- 共通ロガーを導入（レベル: debug/info/warn/error）。

9) リポジトリ衛生
- `public/projects/**`（生成物）は `.gitignore` 対象提案。
- 大容量バイナリ（GLB/PSD）は LFS または外部配信の検討を ADR に記録。
- `*.bak`/`*.backup`/テスト HTML は `examples/` 等に集約。

---

## 長期（1–2週間）保守性/品質向上

10) 大規模ファイルの分割
- `src/views/editor.js`・`src/views/ar-viewer.js`・`components/loading-screen/*` を責務単位に分割。
- 単体テスト可能な粒度へ整理。

11) ストレージ API の統一
- `src/api/projects.js` と `src/api/projects-new.js` を統合し、IndexedDB＋軽量 localStorage の一貫 API を提供。
- 既存データのマイグレーション・リカバリ手順を整備。

12) パフォーマンス/メモリ
- Three.js リソース解放の徹底（dispose/テクスチャ/ジオメトリ）。
- バンドルサイズ監視とチャンク設計の見直し。

---

## 実装の優先度と担当（案）

- P0: 1) 2) 3) 4)
- P1: 5) 6) 7) 8)
- P2: 9) 10) 11) 12)

必要に応じて、各項目の詳細タスクを Issue 化し、PR には影響範囲とスクショ（PC/モバイル）を添付してください。

## 追加で直したほうがいいところ（2025-08-29）

- UI/ネットワーク案内の強化: `src/components/ui.js:401` で `GET /api/network-info` を取得していますが、検出 IP が `localhost` または取得失敗（`null`）の場合に、QR モーダル上へ「同一端末のみアクセス可」「HTTPS 必須」のバナーを明示表示し、`#/usage-guide` へのリンクを追加する（「自己署名証明書の許可」手順へ直接誘導）。
- ログ出力の統一: `src/components/loading-screen/` 配下（例: `settings.js` や `event-handlers.js`）に直接の `console.log` が多数あります。`window.DEBUG` または `import.meta.env.DEV` を用いた `dlog` で統一し、本番ビルドからは除去する（既存の `IS_DEBUG/dlog` パターンへ寄せる）。
- CORS/セキュリティ（レガシーサーバー系）: `server/simple-server.js:124` と `server/app.js:19` はワイルドカードCORSです。運用想定があるなら、環境変数（例: `ALLOWED_ORIGIN`）で限定し、Express 利用時は `helmet` と `morgan` を有効化する（Vite 開発は現状のままでOK）。
- サンプル/検証用ファイルの整理: ルート直下の `qr-simple-ar.html`、`integrated-ar-viewer.html`、`marker-test-*.html`、`simple-*`、`network-test.html`、`test-save.html` などは `examples/` ディレクトリへ集約（`.gitignore` は現状のままでOK）。
- バックアップファイルの集約: `src/views/editor.js.backup` は `backup/` 以下に移動し、参照を断つ（現状インポートされていないが、誤参照防止）。
- API 実装の二重化解消: `src/api/projects.js` と `src/api/projects-new.js` の責務が重複。IndexedDB + 軽量 localStorage の一本化 API を定義し、既存呼び出し箇所を段階的に移行（中期 11) と整合）。
- CODEOWNERS の適用範囲明確化: ルートの `CODEOWNERS` は存在（README の記載と整合）。`vite/plugins/**` と `server/**` の所有者も必要に応じて追加し、API/ビルド設定変更時の承認フローを明示。

（補足）現時点で `vite.config.js` はキャッシュバスティングに `Date.now()` を使わずハッシュ化済み、`optimizeDeps` も適正設定、`.gitignore` に `public/projects/` と `uploads/` が含まれているため、直近の大幅修正は不要です。
