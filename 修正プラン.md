# WebAR 統合修正プラン（最新版）

**最終更新**: 2025-12-30  
**ステータス**: 進行中  
**ベース**: `docs/webar-fix-plan-2025-12.md` + 過去の修正プラン統合

---

## 📊 現状サマリー

### ✅ 完了済み項目

#### 過去の修正（2025-10-01版から）
- ✅ 実装分断の解消（擬似検出フロー停止、実エンジン経路への一本化）
- ✅ ステート遷移修正（`launch_requested→permission_prompt→camera_starting`）
- ✅ カスタムガイド優先表示（`guideScreen.markerGuide.*`の絶対URL化）
- ✅ マーカー(.patt/画像)優先ローディング
- ✅ GLTFLoader レース解消（再初期化ロジック追加）
- ✅ `cleanup()`メソッド実装（`marker-ar.js:1344`で`destroy()`から呼び出し）

#### 最新の修正（2025-12-30版から）
- ✅ 診断ページとスモークテストページの実装
- ✅ プロジェクト整理・不要ファイル削除
- ✅ Feature flags による UI 制御（`DEV_TAKEOVER_UI=false` 等）
- ✅ 単一フェッチ・重複検知の仕組み導入
- ✅ AR状態機械（`ar-state-machine.js`）の実装完了
- ✅ `ar-viewer.js`での状態機械インポート（3027行目で初期化）

---

## 🔴 P0: クリティカル修正（緊急対応必須）

### P0-1: デバッグコード除去 ⚠️ **未完了**

**場所**: `src/views/ar-viewer.js:2342`

**問題**:
```javascript
console.log('XXXXX このログが見えますか？ XXXXX');
```

**修正内容**:
- デバッグ用の`XXXXX`ログを削除
- 緊急修正コード（2344-2377行付近）を正式ロジックに統合または削除

**検証**:
- [ ] `XXXXX`を含むログが出力されないこと
- [ ] 機能が正常に動作すること

---

### P0-2: markerController 初期化タイミング修正 ⚠️ **要確認**

**場所**: `src/views/ar-viewer.js:691, 720-744`

**問題**:
- `markerController`は1067行目で定義されているが、使用箇所で初期化前にアクセスしている可能性
- `markerController?.addImageMarker`のオプショナルチェーンはあるが、未定義時のエラーハンドリングが不十分

**修正内容**:
```javascript
// markerController の初期化確認を追加
if (!markerController || typeof markerController.addImageMarker !== 'function') {
  console.error('[AR] markerController not initialized');
  // エラー処理または初期化
  return;
}
```

**検証**:
- [ ] マーカー画像が正常に登録されること
- [ ] コンソールに undefined エラーがないこと
- [ ] マーカー検出が正常に動作すること

---

## 🟡 P1: 重要修正（UX阻害レベル）

### P1-1: ar-state-machine の統合活用 ⚠️ **部分実装**

**現状**:
- `ar-state-machine.js`は実装済み
- `ar-viewer.js`でインポート・初期化はされている（3027行目）
- しかし、実際の状態遷移ロジックが状態機械経由になっていない可能性

**修正内容**:
```javascript
// ar-viewer.js で状態機械を完全統合
class ARViewer {
  constructor() {
    this.stateMachine = createARStateMachine({
      onStateChange: this.handleStateChange.bind(this),
      onError: this.handleError.bind(this)
    });
  }

  async onStartClick() {
    await this.stateMachine.transition(ARState.LAUNCH_REQUESTED);
  }

  handleStateChange(newState, oldState, data) {
    // UI 更新を一元管理
    switch (newState) {
      case ARState.CAMERA_STARTING:
        this.showLoadingScreen();
        break;
      case ARState.RUNNING:
        this.hideLoadingScreen();
        break;
      // ...
    }
  }
}
```

**状態遷移図**:
```
IDLE → LAUNCH_REQUESTED → PERMISSION_PROMPT → CAMERA_STARTING/XR_STARTING 
  → LOADING_ASSETS → PLACING → RUNNING → (DISPOSED)
         ↓           ↓              ↓
       ERROR ←←←←←←←←←←←←←←←←←←←←←←←
```

**検証**:
- [ ] 状態遷移ログが正常に出力されること
- [ ] 「スタート → ローディング → ガイド → AR」の順で遷移すること
- [ ] エラー時の復帰が正常に動作すること

---

### P1-2: ar-viewer.js 責任分離（リファクタリング） 📋 **計画中**

**現状**: `ar-viewer.js`が3,599行と肥大化

**修正方針**:
新規ファイル作成:
- `src/services/project-loader.js` - プロジェクト読み込み・正規化
- `src/services/marker-pipeline.js` - マーカー処理パイプライン
- `src/services/ar-session-manager.js` - ARセッション管理

**分離後の ar-viewer.js**:
```javascript
// 3,599行 → 約800行に削減
class ARViewer {
  constructor() {
    this.projectLoader = new ProjectLoader();
    this.markerPipeline = new MarkerPipeline();
    this.sessionManager = new ARSessionManager();
    this.stateMachine = createARStateMachine();
  }

  async initialize(projectSrc) {
    const project = await this.projectLoader.load(projectSrc);
    await this.markerPipeline.prepare(project);
    await this.sessionManager.start();
  }
}
```

**検証**:
- [ ] 機能が正常に動作すること
- [ ] コード行数が削減されていること
- [ ] 単体テストが可能な粒度になっていること

---

### P1-3: ログ出力の統一 📋 **計画中**

**場所**: `src/components/loading-screen/`配下、`src/views/ar-viewer.js`

**問題**:
- 直接の`console.log`が多数存在
- 本番ビルドでログが残る

**修正内容**:
```javascript
// 統一ロガーの使用
import { dlog } from '../utils/logger.js';

// 既存の console.log を置き換え
dlog('デバッグ情報', data); // 開発時のみ出力
```

**検証**:
- [ ] 本番ビルドで不要なログが出力されないこと
- [ ] 開発時は適切にログが出力されること

---

## 🟢 P2: 改善（将来対応レベル）

### P2-1: UI 乗っ取りメカニズム統一 📋 **計画中**

**方針**: `takeover-viewer-standalone.js`を廃止、`ar-viewer.js`に一本化

---

### P2-2: Fetch 最適化 📋 **計画中**

**修正内容**:
- HEAD リクエストを廃止
- GET リクエストで存在確認と取得を同時実行
- キャッシュ活用

---

### P2-3: Three.js/GLTFLoader 統一 📋 **計画中**

**方針**: 全ファイルで動的インポート + バージョン固定

---

## 📋 中期（3–5 日）コード/運用の整理

### 5. 重複実装の段階的解消
- `server/simple-server.js`と`vite/plugins/projectsApi.js`の仕様乖離を洗い出し、1つに集約する設計 ADR を作成
- 開発: Vite のみ／配布: `npm run start`の二系統方針を README に確定（済）

### 6. セキュリティ/堅牢化
- `publish-project`/`save`のリクエストサイズ上限（例: 10–20MB）を設定
- CORS の緩すぎる`*`を縮小（ローカル開発では許容、本番/配布時は同一オリジン）
- Express 利用時は`helmet`を有効化、`morgan`で最低限のアクセスログ

### 7. ビルド設定の安定化
- `vite.config.js`の`Date.now()`付与でビルドが非決定になる点を解消（キャッシュ制御はハッシュで十分）
- `optimizeDeps.force: true`を常時ではなく必要時に限定

### 8. ログ/デバッグの整理
- 主要箇所以外の`console.log`を`DEBUG`フラグで抑制し、本番ビルドでは除去
- 共通ロガーを導入（レベル: debug/info/warn/error）

### 9. リポジトリ衛生
- `public/projects/**`（生成物）は`.gitignore`対象提案
- 大容量バイナリ（GLB/PSD）は LFS または外部配信の検討を ADR に記録
- `*.bak`/`*.backup`/テスト HTML は`examples/`等に集約

---

## 📋 長期（1–2 週間）保守性/品質向上

### 10. 大規模ファイルの分割
- `src/views/editor.js`・`src/views/ar-viewer.js`・`components/loading-screen/*`を責務単位に分割
- 単体テスト可能な粒度へ整理

### 11. ストレージ API の統一
- `src/api/projects.js`と`src/api/projects-new.js`を統合し、IndexedDB ＋軽量 localStorage の一貫 API を提供
- 既存データのマイグレーション・リカバリ手順を整備

### 12. パフォーマンス/メモリ
- Three.js リソース解放の徹底（dispose/テクスチャ/ジオメトリ）
- バンドルサイズ監視とチャンク設計の見直し

---

## 📋 将来対応（プロジェクト完成後）

### 13. Vercelデプロイ環境でのファイル永続保存対応 📋 **将来対応**

**現状**:
- Vercelにデプロイ可能な設定は実装済み（`api/`ディレクトリにServerless Functions、`vercel.json`設定）
- ただし、ファイル保存機能は`/tmp`への一時保存のみで、QRコード生成機能が動作しない

**問題点**:
- QRコード生成時、`/projects/${id}/project.json`のURLが生成されるが、ファイルが永続化されていないため404エラーになる
- スマホでのQRコードテストができない

**対応方針**:
- Vercel Blob Storageを使用してファイルを永続的に保存
- 実装ガイド: `docs/vercel-blob-implementation.md` を参照
- 主な手順:
  1. `npm install @vercel/blob` でパッケージをインストール
  2. Vercel Dashboardで環境変数 `BLOB_READ_WRITE_TOKEN` を設定
  3. `api/projects/[id]/save.js` と `api/publish-project.js` を更新してBlob Storageを使用

**参考**:
- Vercelデプロイ手順: `docs/vercel-deployment.md`
- Vercel Blob Storage実装ガイド: `docs/vercel-blob-implementation.md`

**注意**: プロジェクトが一通り動作するまでは、ローカル開発環境でのテストを継続し、この対応は後回しとする。

---

## 🎯 実装優先順位

```
Week 1: P0-1, P0-2 (クリティカル修正)
Week 2: P1-1, P1-3 (状態機械統合・ログ統一)
Week 3-4: P1-2 (リファクタリング)
Week 5+: P2項目 (改善)
```

---

## ✅ 検証環境

### 必須テスト端末
- iPhone Safari（最新iOS）
- Android Chrome（最新）
- PC Chrome（開発用）

### テストURL
```
https://localhost:3000/?src=/projects/sample-keep-me/project.json#/viewer
```

### 成功基準
- [ ] Network: project.json 1回のみ
- [ ] Console: エラー0件、`[FETCH] DUPLICATE` 0件
- [ ] Flow: スタート → ローディング → ガイド → AR
- [ ] destroy() 呼び出しでエラーなし
- [ ] マーカー検出が正常に動作
- [ ] カスタムガイドが表示される

---

## 🚨 緊急時対応

### ロールバック手順
```bash
# 直前のコミットに戻す
git revert HEAD
npm run build && npm run preview
```

### Feature Flag による無効化
```javascript
// src/config/feature-flags.js
export const FEATURE_NEW_STATE_MACHINE = false;  // 新機能を無効化
```

---

## 📚 参考リンク

- 旧プラン: `docs/webar-fix-plan-2025-12.md`
- 根本原因調査: `docs/webar-rootcause.md`
- ルート: `docs/routes.md`

---

## 📝 追加で直したほうがいいところ（2025-08-29版から）

### UI/ネットワーク案内の強化
- `src/components/ui.js:401`で`GET /api/network-info`を取得
- 検出 IP が`localhost`または取得失敗（`null`）の場合に、QR モーダル上へ「同一端末のみアクセス可」「HTTPS 必須」のバナーを明示表示
- `#/usage-guide`へのリンクを追加（「自己署名証明書の許可」手順へ直接誘導）

### CORS/セキュリティ（レガシーサーバー系）
- `server/simple-server.js:124`と`server/app.js:19`はワイルドカード CORS
- 運用想定があるなら、環境変数（例: `ALLOWED_ORIGIN`）で限定
- Express 利用時は`helmet`と`morgan`を有効化（Vite 開発は現状のままで OK）

### サンプル/検証用ファイルの整理
- ルート直下の`qr-simple-ar.html`、`integrated-ar-viewer.html`、`marker-test-*.html`、`simple-*`、`network-test.html`、`test-save.html`などは`examples/`ディレクトリへ集約

### バックアップファイルの集約
- `src/views/editor.js.backup`は`backup/`以下に移動し、参照を断つ

### API 実装の二重化解消
- `src/api/projects.js`と`src/api/projects-new.js`の責務が重複
- IndexedDB + 軽量 localStorage の一本化 API を定義し、既存呼び出し箇所を段階的に移行（中期 11) と整合）

### CODEOWNERS の適用範囲明確化
- ルートの`CODEOWNERS`は存在（README の記載と整合）
- `vite/plugins/**`と`server/**`の所有者も必要に応じて追加し、API/ビルド設定変更時の承認フローを明示

---

## 🎯 受け入れ基準（最終ゴール）

### 基本動作
- [ ] 同一プロジェクトで以下を 3 回連続で成功：
  1. PC で QR 表示 → スマホでスキャン → スタート → カメラ起動
  2. カスタムガイド画像・文言が表示（既定枠なし）
  3. 保存したマーカーで検出 → 3D モデル表示（回転等の微アニメ付与で視認）

### エラーハンドリング
- [ ] 失敗時は UI に原因ヒント（CORS/404/画像タイプ不正/権限拒否）を表示
- [ ] 再試行可能な状態になっていること

### パフォーマンス
- [ ] 大容量モデルでも UI が固まらず進捗表示される
- [ ] メモリリークがないこと（DevTools Memory タブ）

---

**最終更新**: 2025-12-30  
**次回レビュー**: 2026-01-15
