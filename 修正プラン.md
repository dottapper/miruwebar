2025-08-28 改訂版（ドキュメント統一後の修正案）

目的: 「制作 → 保存 → QR → 実機AR」を高確度に成功させるため、運用・実装の分散を解消し、不具合・混乱源を段階的に削減する。

## 直近（1–2日）実用優先タスク

1) サーバー/API の一本化（開発時）
- 開発は Vite のみを正とする（`npm run dev`）。
- `vite/plugins/*` の API を基準仕様とし、`server/simple-server.js`/`server/app.js` はレガシー扱い（README 反映済み）。
- UI 文言を見直し、「公開URL/同一端末のみ/HTTPS必須」の案内を強化。

2) QR → 実機配信の体験強化
- `network-info` が `localhost` のときの警告を表示（同一端末のみアクセス可）。
- HTTPS アクセスのガイド（自己署名証明書の許可手順）を UI から参照可能に。

3) Viewer のローディング設定反映の網羅
- `loadingScreen` の下記項目を viewer で確実に反映（現状の不足分を補う）。
  - 背景色、テキスト色、進捗色（`accentColor` 互換含む）、メッセージ、ロゴ表示、`showProgress=false` 時のバー非表示。

4) ドキュメント整備の最小完了
- README（統一ルール、サーバー構成、標準手順、トラブルシュート）更新済み。
- `docs/routes.md` に `#/viewer`, `#/usage-guide` を追記済み。
- CONTRIBUTING にドキュメント同期ルールを追記済み。

受け入れ基準
- マーカー/マーカーレス双方で「PC→QR→スマホ viewer 表示」が連続 3 回成功。
- `loadingScreen` の各設定が `project.json → viewer` へ期待通り反映。
- `localhost`/HTTP などの落とし穴で、ユーザーが UI 上の案内だけで復帰可能。

---

## 中期（3–5日）コード/運用の整理

5) 重複実装の段階的解消
- `server/simple-server.js` と `vite/plugins/projectsApi.js` の仕様乖離を洗い出し、1 つに集約する設計 ADR を作成。
- 開発: Vite のみ／配布: `npm run start` の二系統方針を README に確定（済）。

6) セキュリティ/堅牢化
- `publish-project`/`save` のリクエストサイズ上限（例: 10–20MB）を設定し、過大投稿を防止。
- CORS の緩すぎる `*` を縮小（ローカル開発では許容、本番/配布時は同一オリジン）。
- Express 利用時は `helmet` を有効化、`morgan` で最低限のアクセスログ。

7) ビルド設定の安定化
- `vite.config.js` の `Date.now()` 付与でビルドが非決定になる点を解消（キャッシュ制御はハッシュで十分）。
- `optimizeDeps.force: true` を常時ではなく必要時に限定。

8) ログ/デバッグの整理
- 主要箇所以外の `console.log` を `DEBUG` フラグで抑制し、本番ビルドでは除去。
- 共通ロガーを導入（レベル: debug/info/warn/error）。

9) リポジトリ衛生
- `public/projects/**`（生成物）は `.gitignore` 対象提案。
- 大容量バイナリ（GLB/PSD）は LFS または外部配信の検討を ADR に記録。
- `*.bak`/`*.backup`/テスト HTML は `examples/` 等に集約。

---

## 長期（1–2週間）保守性/品質向上

10) 大規模ファイルの分割
- `src/views/editor.js`・`src/views/ar-viewer.js`・`components/loading-screen/*` を責務単位に分割。
- 単体テスト可能な粒度へ整理。

11) ストレージ API の統一
- `src/api/projects.js` と `src/api/projects-new.js` を統合し、IndexedDB＋軽量 localStorage の一貫 API を提供。
- 既存データのマイグレーション・リカバリ手順を整備。

12) パフォーマンス/メモリ
- Three.js リソース解放の徹底（dispose/テクスチャ/ジオメトリ）。
- バンドルサイズ監視とチャンク設計の見直し。

---

## 実装の優先度と担当（案）

- P0: 1) 2) 3) 4)
- P1: 5) 6) 7) 8)
- P2: 9) 10) 11) 12)

必要に応じて、各項目の詳細タスクを Issue 化し、PR には影響範囲とスクショ（PC/モバイル）を添付してください。

