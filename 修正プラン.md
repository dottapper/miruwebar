2025-10-01 改訂版（WebAR 不作動の根本原因と修復プラン）

目的: 「制作 → 保存 →QR→ 実機 AR」を確実に動作させる。実装の分断を解消し、マーカー検出から 3D 表示・ガイド反映までを一つの経路に統合する。

## 1. 現状と無効だった修正の整理

- 実装分断

  - `src/views/ar-viewer.js` に擬似検出（手動トグル）経路があり、実エンジン（`src/components/ar/marker-ar.js`）の検出結果と UI/3D 表示が繋がっていなかった。
  - これにより「マーカーをスキャンしても 3D が出ない」症状が継続。

- ステート誤遷移/タイムアウト

  - `launch_requested→camera_starting` の直接遷移（不許可）。`permission_prompt` を経由する必要があった。
  - `running` にタイムアウト（30s）が設定され、継続利用でエラーになっていた。

- ガイド/ローディングの非反映

  - ガイド画像・文言の優先度と適用タイミングが不統一。プロジェクト保存のデザインが既定ガイドに隠れていた。
  - ローディング/スタートの適用経路が複数あり、競合・上書き事故が発生。

- 3D モデル読み込みレース

  - `MarkerAR.start()` 呼び出し時に `GLTFLoader` 未初期化で失敗するレースが発生。

- マーカーの取り扱い
  - `.patt`優先/画像からの生成/CORS 検証の流れが分散。エラー時のフォールバックが不十分。

（上記は今回の修正で順次解消済み／一部継続）

## 2. 決定方針（Single Source of Truth）

- AR 実行は常に状態機械（`ar-state-machine.js`）＋`AREngineAdapter`経由。
  - iOS Safari ＝ MarkerAR、Android Chrome/PC ＝ WebXR を自動選択 or `engine` URL 指定で強制。
- マーカー検出 →3D 配置は `MarkerAR` の `markerRoot` 上でのみ実施。
- ガイド/ローディング/スタートの適用は `project.json` を最優先に、エディタローカルは `?ls=on` の時のみ不足補完。

## 3. これまでに実施した修正（今回）

- 実経路統合
  - 擬似検出フロー呼び出し停止。開始ボタン → 状態機械 →`AREngineAdapter`→`MarkerAR`へ一本化。
- ステート遷移修正
  - `launch_requested→permission_prompt→camera_starting/xr_starting` に是正。
  - `running` のタイムアウト無効化。
- カスタムガイド優先表示
  - `guideScreen.markerGuide.*`（title/description/guideImage）を絶対 URL 化して優先表示。既定の緑枠は自動非表示。
  - `previewImage` または `markerImage/markerImageUrl` をサムネとして補助表示。
- マーカー(.patt/画像)優先ローディング
  - `markerPattern`（文字列）優先。無ければ `markerImage/markerImageUrl` から `.patt` 生成し `MarkerAR` に渡す。
- GLTFLoader レース解消
  - `MarkerAR.start()` 内で `modelLoader` 未初期化を検出して再初期化（短期待機を挿入）。

## 4. これからの修正プラン（短期 1–3 日）

P0: 実利用へ直結する項目

1. ガイド適用の最終確定

   - 受け入れ: `guideScreen.markerGuide` の画像・文言がスマホ実機で表示。既定枠は出ない。
   - 追加: 画像比率に応じた `object-fit`/max サイズ調整、テキスト改行/行間の既定値をデザインに合わせる。

2. マーカー生成/CORS の堅牢化

   - 画像 URL 到達性チェック（HEAD/GET で`content-type:image/*`判定）と詳細ログ。
   - 失敗時: プロジェクト内フォールバック、最後の手段として `patt.hiro` に自動切替し UI に警告表示。

3. 3D モデル読み込みの可視化

   - `MarkerAR` に進捗ハンドラ（%）を渡し、ローディング UI に反映。
   - 受け入れ: 大容量モデルでも UI が固まらず進捗表示される。

4. 例外時の復帰動線
   - 状態機械 `ERROR` 遷移時に「再試行」ボタン（既存）をガイド面に固定表示。
   - ログに `viewerUrl`/`projectSrc`/`engine` をまとめて出力（再現容易化）。

P1: 品質/操作性の補強

5. デバッグスイッチ

   - `debug=1` で UI に最小限のログパネルを出し、主要キー（projectSrc/engine/custom-guide 有無）を即確認。

6. パラメータスナップショット
   - `#/viewer?src=...` アクセス時に、解決済みの`project`要約を`console.table`で出力（カスタムガイド/マーカー/モデル本数）。

## 5. 受け入れ基準（今回のゴール）

- 同一プロジェクトで以下を 3 回連続で成功：
  1. PC で QR 表示 → スマホでスキャン → スタート → カメラ起動
  2. カスタムガイド画像・文言が表示（既定枠なし）
  3. 保存したマーカーで検出 → 3D モデル表示（回転等の微アニメ付与で視認）
- 失敗時は UI に原因ヒント（CORS/404/画像タイプ不正/権限拒否）を表示し、再試行可能。

## 6. ロールバック/切替方針

- `engine`（`marker`/`webxr`）を URL で強制できる。
- 旧来の擬似検出フローは呼び出しを停止済み。必要時は一時的に`featureFlag=legacy`で復帰テスト可能（導入検討）。

## 7. 検証手順（実機）

1. プロジェクト編集 → ガイド画像/文言・マーカー・モデルを保存
2. QR 生成 → `#/viewer?src=.../project.json`
3. スマホでアクセス → 「開始」 → カメラ許可
4. ガイド確認（カスタム表示）→ マーカーを合わせる
5. 3D 表示/追従確認（影響があれば `&cube=on` でデバッグキューブ併用）

## 8. 今後の課題（中期）

- 大規模ファイルの責務分割（`ar-viewer.js`の UI/状態/適用系を分離）
- ストレージ API の一本化（IndexedDB ＋ localStorage）
- CI でのスモーク E2E（Viewer 起動/ガイド表示/GLB ロード成功）

1. サーバー/API の一本化（開発時）

- 開発は Vite のみを正とする（`npm run dev`）。
- `vite/plugins/*` の API を基準仕様とし、`server/simple-server.js`/`server/app.js` はレガシー扱い（README 反映済み）。
- UI 文言を見直し、「公開 URL/同一端末のみ/HTTPS 必須」の案内を強化。

2. QR → 実機配信の体験強化

- `network-info` が `localhost` のときの警告を表示（同一端末のみアクセス可）。
- HTTPS アクセスのガイド（自己署名証明書の許可手順）を UI から参照可能に。

3. Viewer のローディング設定反映の網羅

- `loadingScreen` の下記項目を viewer で確実に反映（現状の不足分を補う）。

  - 背景色、テキスト色、進捗色（`accentColor` 互換含む）、メッセージ、ロゴ表示、`showProgress=false` 時のバー非表示。

  3.1) ローディング画面設定のエクスポート/インポート機能（完了済み）

- 📤 エクスポートボタン：設定を JSON ファイルでダウンロード
- 📥 インポートボタン：JSON ファイルから設定を読み込み
- IP 間同期：同一端末・同一ブラウザ内での IP アドレス変更対応
- 端末間移行：エクスポート/インポートによる設定共有（自宅 ↔ 会社対応）

4. ドキュメント整備の最小完了

- README（統一ルール、サーバー構成、標準手順、トラブルシュート）更新済み。
- README にデータ保存仕様（IndexedDB/localStorage/エクスポート）を詳細追記済み。
- `docs/routes.md` に `#/viewer`, `#/usage-guide` を追記済み。
- CONTRIBUTING にドキュメント同期ルールを追記済み。

  4.1) 使い方ページへの追加予定内容
  **端末間移行ワークフロー（自宅 ↔ 会社対応）:**

自宅での作業終了時：

1. ローディング画面設定を編集・保存
2. 📤 エクスポートボタンで JSON ファイルダウンロード
3. ファイルを USB/クラウドストレージに保存

会社での作業開始時：

1. miruwebar.com にアクセス
2. 📥 インポートボタンで JSON ファイル選択
3. 設定が復元され、続きから作業可能

**対応状況:**

- ✅ 同一端末・同一ブラウザ：IP 間自動同期
- ✅ 異なる端末・ブラウザ：エクスポート/インポート
- ⏳ 将来：プロジェクト保存時にローディング画面設定も含める予定

## 長期（2–4 週間）ハイブリッド保存方式の実装

**サーバー保存モードの追加（レンタルサーバー対応）:**

実装予定機能：

- ユーザーアカウント機能（簡易認証）
- サーバー保存モード選択 UI
- プロジェクト URL 共有機能
- 自動同期オプション
- チーム連携・権限管理

**保存方式選択:**

- ローカル保存（デフォルト）：高速開発、オフライン対応
- サーバー保存：チーム開発、商用利用、永続保存

**移行サポート:**

- ローカル → サーバー移行機能
- サーバー → ローカル移行機能
- エクスポート/インポートによるデータ移行

受け入れ基準

- マーカー/マーカーレス双方で「PC→QR→ スマホ viewer 表示」が連続 3 回成功。
- `loadingScreen` の各設定が `project.json → viewer` へ期待通り反映。
- `localhost`/HTTP などの落とし穴で、ユーザーが UI 上の案内だけで復帰可能。

---

## 中期（3–5 日）コード/運用の整理

5. 重複実装の段階的解消

- `server/simple-server.js` と `vite/plugins/projectsApi.js` の仕様乖離を洗い出し、1 つに集約する設計 ADR を作成。
- 開発: Vite のみ／配布: `npm run start` の二系統方針を README に確定（済）。

6. セキュリティ/堅牢化

- `publish-project`/`save` のリクエストサイズ上限（例: 10–20MB）を設定し、過大投稿を防止。
- CORS の緩すぎる `*` を縮小（ローカル開発では許容、本番/配布時は同一オリジン）。
- Express 利用時は `helmet` を有効化、`morgan` で最低限のアクセスログ。

7. ビルド設定の安定化

- `vite.config.js` の `Date.now()` 付与でビルドが非決定になる点を解消（キャッシュ制御はハッシュで十分）。
- `optimizeDeps.force: true` を常時ではなく必要時に限定。

8. ログ/デバッグの整理

- 主要箇所以外の `console.log` を `DEBUG` フラグで抑制し、本番ビルドでは除去。
- 共通ロガーを導入（レベル: debug/info/warn/error）。

9. リポジトリ衛生

- `public/projects/**`（生成物）は `.gitignore` 対象提案。
- 大容量バイナリ（GLB/PSD）は LFS または外部配信の検討を ADR に記録。
- `*.bak`/`*.backup`/テスト HTML は `examples/` 等に集約。

---

## 長期（1–2 週間）保守性/品質向上

10. 大規模ファイルの分割

- `src/views/editor.js`・`src/views/ar-viewer.js`・`components/loading-screen/*` を責務単位に分割。
- 単体テスト可能な粒度へ整理。

11. ストレージ API の統一

- `src/api/projects.js` と `src/api/projects-new.js` を統合し、IndexedDB ＋軽量 localStorage の一貫 API を提供。
- 既存データのマイグレーション・リカバリ手順を整備。

12. パフォーマンス/メモリ

- Three.js リソース解放の徹底（dispose/テクスチャ/ジオメトリ）。
- バンドルサイズ監視とチャンク設計の見直し。

---

## 実装の優先度と担当（案）

- P0: 1) 2) 3) 4)
- P1: 5) 6) 7) 8)
- P2: 9) 10) 11) 12)

必要に応じて、各項目の詳細タスクを Issue 化し、PR には影響範囲とスクショ（PC/モバイル）を添付してください。

## 追加で直したほうがいいところ（2025-08-29）

- UI/ネットワーク案内の強化: `src/components/ui.js:401` で `GET /api/network-info` を取得していますが、検出 IP が `localhost` または取得失敗（`null`）の場合に、QR モーダル上へ「同一端末のみアクセス可」「HTTPS 必須」のバナーを明示表示し、`#/usage-guide` へのリンクを追加する（「自己署名証明書の許可」手順へ直接誘導）。
- ログ出力の統一: `src/components/loading-screen/` 配下（例: `settings.js` や `event-handlers.js`）に直接の `console.log` が多数あります。`window.DEBUG` または `import.meta.env.DEV` を用いた `dlog` で統一し、本番ビルドからは除去する（既存の `IS_DEBUG/dlog` パターンへ寄せる）。
- CORS/セキュリティ（レガシーサーバー系）: `server/simple-server.js:124` と `server/app.js:19` はワイルドカード CORS です。運用想定があるなら、環境変数（例: `ALLOWED_ORIGIN`）で限定し、Express 利用時は `helmet` と `morgan` を有効化する（Vite 開発は現状のままで OK）。
- サンプル/検証用ファイルの整理: ルート直下の `qr-simple-ar.html`、`integrated-ar-viewer.html`、`marker-test-*.html`、`simple-*`、`network-test.html`、`test-save.html` などは `examples/` ディレクトリへ集約（`.gitignore` は現状のままで OK）。
- バックアップファイルの集約: `src/views/editor.js.backup` は `backup/` 以下に移動し、参照を断つ（現状インポートされていないが、誤参照防止）。
- API 実装の二重化解消: `src/api/projects.js` と `src/api/projects-new.js` の責務が重複。IndexedDB + 軽量 localStorage の一本化 API を定義し、既存呼び出し箇所を段階的に移行（中期 11) と整合）。
- CODEOWNERS の適用範囲明確化: ルートの `CODEOWNERS` は存在（README の記載と整合）。`vite/plugins/**` と `server/**` の所有者も必要に応じて追加し、API/ビルド設定変更時の承認フローを明示。

（補足）現時点で `vite.config.js` はキャッシュバスティングに `Date.now()` を使わずハッシュ化済み、`optimizeDeps` も適正設定、`.gitignore` に `public/projects/` と `uploads/` が含まれているため、直近の大幅修正は不要です。
