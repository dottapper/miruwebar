# WebAR 統合修正プラン

**最終更新**: 2025-12-31
**ステータス**: 進行中

---

## 📊 現状サマリー

### ✅ 完了済み項目

#### インフラ・基盤
- ✅ 実装分断の解消（擬似検出フロー停止、実エンジン経路への一本化）
- ✅ ステート遷移修正（`launch_requested→permission_prompt→camera_starting`）
- ✅ マーカー(.patt/画像)優先ローディング
- ✅ GLTFLoader レース解消（再初期化ロジック追加）
- ✅ `cleanup()`メソッド実装
- ✅ AR状態機械（`ar-state-machine.js`）の実装・インポート完了

#### UI/UX
- ✅ カスタムガイド優先表示（`guideScreen.markerGuide.*`の絶対URL化）
- ✅ QRスキャン後のUI設定優先順位修正
- ✅ QRスキャン後のマーカーARビューでUI設定を正しく適用
- ✅ 診断ページとスモークテストページの実装
- ✅ Feature flags による UI 制御

#### コード品質
- ✅ プロジェクト整理・不要ファイル削除
- ✅ 単一フェッチ・重複検知の仕組み導入
- ✅ `logger.js`（統一ロガー）実装済み

#### デプロイ
- ✅ Firebase Storage CORS設定・書き込み権限設定
- ✅ Firebase公開時のproject.jsonスキーマ修正

---

## 🔴 P0: クリティカル修正（今すぐ対応）

### P0-1: デバッグコード除去 ⚠️ 未完了

**場所**: [ar-viewer.js:2362](src/views/ar-viewer.js#L2362)

**問題**:
```javascript
console.log('XXXXX このログが見えますか？ XXXXX');
```
- デバッグ用の`XXXXX`ログが本番コードに残存
- 緊急修正コード（2364行以降）が正式ロジックに未統合

**対応**:
1. `XXXXX`を含むログを削除
2. 緊急修正コードを正式ロジックに統合または削除
3. 周辺の不要な`console.log`を整理

---

## 🟡 P1: 重要修正（UX改善）

### P1-1: ar-state-machine の完全活用 ⚠️ 部分実装

**現状**:
- `ar-state-machine.js`は実装済み
- `ar-viewer.js`でインポートされている（11行目）
- 実際の状態遷移ロジックが状態機械経由に統一されていない可能性

**対応**:
- 全ての状態遷移を`stateMachine.transition()`経由に統一
- UI更新を`onStateChange`コールバックに集約

**状態遷移図**:
```
IDLE → LAUNCH_REQUESTED → PERMISSION_PROMPT → CAMERA_STARTING
  → LOADING_ASSETS → PLACING → RUNNING → (DISPOSED)
         ↓              ↓         ↓
       ERROR ←←←←←←←←←←←←←←←←←←←←
```

---

### P1-2: ログ出力の統一

**場所**: `src/components/loading-screen/`配下、[ar-viewer.js](src/views/ar-viewer.js)

**問題**:
- 直接の`console.log`が多数存在
- 本番ビルドでログが残る

**対応**:
- 既存の`src/utils/logger.js`（`dlog`）を全体で使用
- 本番ビルドでは出力抑制

---

### P1-3: markerController 初期化の堅牢化

**場所**: [ar-viewer.js:705-758](src/views/ar-viewer.js#L705-L758)、[1081](src/views/ar-viewer.js#L1081)

**現状**:
- `markerController`は1081行目で定義
- オプショナルチェーン（`?.`）で使用されているため致命的エラーは回避
- ただし、初期化前アクセス時のエラーハンドリングが不十分

**対応**:
- 初期化確認ロジックを追加
- エラー時のフォールバック処理を実装

---

## 🟢 P2: 改善（中期対応）

### P2-1: ar-viewer.js の責任分離

**現状**: `ar-viewer.js`が3,675行と肥大化

**対応**:
新規ファイル作成を検討:
- `src/services/project-loader.js` - プロジェクト読み込み・正規化
- `src/services/marker-pipeline.js` - マーカー処理パイプライン
- `src/services/ar-session-manager.js` - ARセッション管理

**目標**: 3,675行 → 約800行に削減

---

### P2-2: Fetch 最適化

**対応**:
- HEAD リクエストを廃止
- GET リクエストで存在確認と取得を同時実行
- キャッシュ活用

---

### P2-3: Three.js/GLTFLoader 統一

**対応**: 全ファイルで動的インポート + バージョン固定

---

### P2-4: UI 乗っ取りメカニズム統一

**対応**: `takeover-viewer-standalone.js`を廃止、`ar-viewer.js`に一本化

---

## 📋 中期タスク（コード/運用整理）

### 重複実装の段階的解消
- `server/simple-server.js`と`vite/plugins/projectsApi.js`の仕様乖離を洗い出し
- 開発: Vite のみ／配布: `npm run start`の二系統方針

### セキュリティ/堅牢化
- `publish-project`/`save`のリクエストサイズ上限（10–20MB）を設定
- CORS の緩すぎる`*`を縮小
- Express 利用時は`helmet`を有効化

### ビルド設定の安定化
- `vite.config.js`の`Date.now()`付与でビルドが非決定になる点を解消
- `optimizeDeps.force: true`を必要時に限定

### リポジトリ衛生
- `public/projects/**`（生成物）は`.gitignore`対象提案
- 大容量バイナリ（GLB/PSD）は LFS または外部配信を検討
- テスト HTML は`examples/`等に集約

---

## 📋 長期タスク（保守性/品質向上）

### 大規模ファイルの分割
- `src/views/editor.js`・`src/views/ar-viewer.js`を責務単位に分割
- 単体テスト可能な粒度へ整理

### ストレージ API の統一
- `src/api/projects.js`と`src/api/projects-new.js`を統合
- IndexedDB ＋軽量 localStorage の一貫 API を提供

### パフォーマンス/メモリ
- Three.js リソース解放の徹底（dispose/テクスチャ/ジオメトリ）
- バンドルサイズ監視とチャンク設計の見直し

---

## 📋 将来対応

### Vercelデプロイ環境でのファイル永続保存

**現状**:
- Vercelデプロイ設定は実装済み
- ファイル保存は`/tmp`への一時保存のみ

**対応**:
- Vercel Blob Storageを使用してファイルを永続保存
- 実装ガイド: [vercel-blob-implementation.md](docs/vercel-blob-implementation.md)

---

## ✅ 検証基準

### テスト環境
- iPhone Safari（最新iOS）
- Android Chrome（最新）
- PC Chrome（開発用）

### 成功基準
- [ ] Network: project.json 1回のみ
- [ ] Console: エラー0件、`[FETCH] DUPLICATE` 0件
- [ ] Flow: スタート → ローディング → ガイド → AR
- [ ] destroy() 呼び出しでエラーなし
- [ ] マーカー検出が正常に動作
- [ ] カスタムガイドが表示される

### テストURL
```
https://localhost:3000/?src=/projects/sample-keep-me/project.json#/viewer
```

---

## 🚨 緊急時対応

### ロールバック手順
```bash
git revert HEAD
npm run build && npm run preview
```

### Feature Flag による無効化
```javascript
// src/config/feature-flags.js
export const FEATURE_NEW_STATE_MACHINE = false;
```

---

## 📚 参考ドキュメント

- [webar-fix-plan-2025-12.md](docs/webar-fix-plan-2025-12.md) - 旧プラン
- [webar-rootcause.md](docs/webar-rootcause.md) - 根本原因調査
- [routes.md](docs/routes.md) - ルート定義
- [vercel-deployment.md](docs/vercel-deployment.md) - Vercelデプロイ手順
- [vercel-blob-implementation.md](docs/vercel-blob-implementation.md) - Blob Storage実装ガイド

---

**最終更新**: 2025-12-31
