<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARè¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        
        .diagnosis-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .step {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #666;
        }
        
        .step.testing {
            border-left-color: #ffa500;
            background: #2a2200;
        }
        
        .step.success {
            border-left-color: #00ff00;
            background: #002200;
        }
        
        .step.error {
            border-left-color: #ff0000;
            background: #220000;
        }
        
        .step-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .step-detail {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .test-video {
            width: 200px;
            height: 150px;
            border: 2px solid #666;
            margin: 10px 0;
        }
        
        .test-canvas {
            width: 200px;
            height: 150px;
            border: 2px solid #666;
            margin: 10px 0;
            background: #333;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a99;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .info-box {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        #ar-test-area {
            width: 300px;
            height: 200px;
            border: 2px solid #ffa500;
            position: relative;
            margin: 20px 0;
            background: #000;
        }
    </style>
</head>
<body>
    <div class="diagnosis-container">
        <h1>ğŸ” ARè¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ARãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„åŸå› ã‚’æ®µéšçš„ã«ç‰¹å®šã—ã¾ã™</p>
        
        <div id="step1" class="step">
            <div class="step-title">1. ãƒ‡ãƒã‚¤ã‚¹ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶åˆ¤å®š</div>
            <div class="step-detail" id="device-info">åˆ¤å®šä¸­...</div>
        </div>
        
        <div id="step2" class="step">
            <div class="step-title">2. ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</div>
            <div class="step-detail" id="camera-info">å¾…æ©Ÿä¸­...</div>
            <video id="test-video" class="test-video" autoplay muted playsInline style="display:none;"></video>
            <button onclick="testCamera()">ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        </div>
        
        <div id="step3" class="step">
            <div class="step-title">3. WebGLãƒ»Three.js ãƒ†ã‚¹ãƒˆ</div>
            <div class="step-detail" id="webgl-info">å¾…æ©Ÿä¸­...</div>
            <canvas id="test-canvas" class="test-canvas" style="display:none;"></canvas>
            <button onclick="testWebGL()">WebGLãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        </div>
        
        <div id="step4" class="step">
            <div class="step-title">4. ARçµ±åˆãƒ†ã‚¹ãƒˆ</div>
            <div class="step-detail" id="ar-info">å¾…æ©Ÿä¸­...</div>
            <div id="ar-test-area">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    AR ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢
                </div>
            </div>
            <button onclick="testAR()">çµ±åˆARãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        </div>
        
        <div id="step5" class="step">
            <div class="step-title">5. è¨ºæ–­çµæœãƒ»ä¿®æ­£æ¡ˆ</div>
            <div class="step-detail" id="result-info">å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Œäº†ã—ã¦ãã ã•ã„</div>
        </div>
        
        <div class="info-grid">
            <div class="info-box">
                <strong>ç¾åœ¨ã®URL:</strong><br>
                <span id="current-url"></span>
            </div>
            <div class="info-box">
                <strong>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:</strong><br>
                <span id="timestamp"></span>
            </div>
        </div>
        
        <button onclick="runFullTest()" style="background: #ff6600; font-size: 16px; padding: 15px 30px;">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let testResults = {
            device: null,
            camera: null,
            webgl: null,
            ar: null
        };
        
        // åˆæœŸåŒ–
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        
        // 1. ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
        function detectDevice() {
            const ua = navigator.userAgent;
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i.test(ua);
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const isSmallScreen = window.innerWidth < 768;
            const isMobileDevice = isMobile || isTouchDevice || isSmallScreen;
            
            const deviceInfo = {
                userAgent: ua,
                isMobile,
                isTouchDevice,
                isSmallScreen,
                isMobileDevice,
                screenSize: { w: window.innerWidth, h: window.innerHeight },
                pixelRatio: window.devicePixelRatio,
                isHTTPS: window.location.protocol === 'https:',
                hasMediaDevices: !!navigator.mediaDevices,
                hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
            };
            
            testResults.device = deviceInfo;
            
            const step1 = document.getElementById('step1');
            step1.className = 'step success';
            document.getElementById('device-info').innerHTML = `
                <strong>ãƒ‡ãƒã‚¤ã‚¹:</strong> ${isMobileDevice ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}<br>
                <strong>ç”»é¢:</strong> ${deviceInfo.screenSize.w}Ã—${deviceInfo.screenSize.h}<br>
                <strong>HTTPS:</strong> ${deviceInfo.isHTTPS ? 'âœ…' : 'âŒ'}<br>
                <strong>MediaDevices:</strong> ${deviceInfo.hasMediaDevices ? 'âœ…' : 'âŒ'}<br>
                <strong>getUserMedia:</strong> ${deviceInfo.hasGetUserMedia ? 'âœ…' : 'âŒ'}
            `;
        }
        
        // 2. ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ
        async function testCamera() {
            const step2 = document.getElementById('step2');
            step2.className = 'step testing';
            document.getElementById('camera-info').textContent = 'ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œä¸­...';
            
            const video = document.getElementById('test-video');
            const cameraConstraints = [
                { video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } },
                { video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } } },
                { video: { facingMode: 'environment' } },
                { video: true }
            ];
            
            let success = false;
            let errorDetails = [];
            
            for (let i = 0; i < cameraConstraints.length; i++) {
                try {
                    console.log(`ã‚«ãƒ¡ãƒ©è¨­å®š${i + 1}ã‚’è©¦è¡Œ:`, cameraConstraints[i]);
                    const stream = await navigator.mediaDevices.getUserMedia(cameraConstraints[i]);
                    video.srcObject = stream;
                    video.style.display = 'block';
                    
                    const videoTrack = stream.getVideoTracks()[0];
                    const settings = videoTrack.getSettings();
                    
                    testResults.camera = {
                        success: true,
                        constraintIndex: i,
                        constraint: cameraConstraints[i],
                        videoTrack: settings
                    };
                    
                    step2.className = 'step success';
                    document.getElementById('camera-info').innerHTML = `
                        <strong>âœ… æˆåŠŸ!</strong> è¨­å®š${i + 1}ã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ<br>
                        <strong>è§£åƒåº¦:</strong> ${settings.width || 'ä¸æ˜'}Ã—${settings.height || 'ä¸æ˜'}<br>
                        <strong>ãƒ•ã‚§ã‚¤ã‚·ãƒ³ã‚°:</strong> ${settings.facingMode || 'unknown'}<br>
                        <strong>ãƒ‡ãƒã‚¤ã‚¹ID:</strong> ${settings.deviceId ? settings.deviceId.substring(0, 20) + '...' : 'unknown'}
                    `;
                    success = true;
                    break;
                } catch (error) {
                    console.error(`ã‚«ãƒ¡ãƒ©è¨­å®š${i + 1}å¤±æ•—:`, error);
                    errorDetails.push(`è¨­å®š${i + 1}: ${error.name} - ${error.message}`);
                }
            }
            
            if (!success) {
                testResults.camera = { success: false, errors: errorDetails };
                step2.className = 'step error';
                document.getElementById('camera-info').innerHTML = `
                    <strong>âŒ å¤±æ•—!</strong> å…¨ã¦ã®ã‚«ãƒ¡ãƒ©è¨­å®šã§å¤±æ•—<br>
                    ${errorDetails.map(e => `â€¢ ${e}`).join('<br>')}
                `;
            }
        }
        
        // 3. WebGLãƒ†ã‚¹ãƒˆ
        function testWebGL() {
            const step3 = document.getElementById('step3');
            step3.className = 'step testing';
            document.getElementById('webgl-info').textContent = 'WebGLåˆæœŸåŒ–ä¸­...';
            
            const canvas = document.getElementById('test-canvas');
            canvas.style.display = 'block';
            canvas.width = 200;
            canvas.height = 150;
            
            try {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
                
                renderer.setSize(200, 150);
                renderer.setClearColor(0x222222, 1);
                
                // ãƒ†ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);
                
                camera.position.z = 3;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                let frame = 0;
                function animate() {
                    frame++;
                    if (frame > 120) return; // 2ç§’ã§åœæ­¢
                    requestAnimationFrame(animate);
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                    renderer.render(scene, camera);
                }
                animate();
                
                const gl = renderer.getContext();
                testResults.webgl = {
                    success: true,
                    version: gl.getParameter(gl.VERSION),
                    vendor: gl.getParameter(gl.VENDOR),
                    renderer: gl.getParameter(gl.RENDERER),
                    maxTextureSize: gl.getParameter(gl.MAX_TEXTURE_SIZE)
                };
                
                step3.className = 'step success';
                document.getElementById('webgl-info').innerHTML = `
                    <strong>âœ… æˆåŠŸ!</strong> WebGLæ­£å¸¸å‹•ä½œ<br>
                    <strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> ${testResults.webgl.version}<br>
                    <strong>ãƒ™ãƒ³ãƒ€ãƒ¼:</strong> ${testResults.webgl.vendor}<br>
                    <strong>ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼:</strong> ${testResults.webgl.renderer.substring(0, 30)}...
                `;
                
            } catch (error) {
                console.error('WebGLã‚¨ãƒ©ãƒ¼:', error);
                testResults.webgl = { success: false, error: error.message };
                step3.className = 'step error';
                document.getElementById('webgl-info').innerHTML = `
                    <strong>âŒ å¤±æ•—!</strong> WebGLåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼<br>
                    ${error.message}
                `;
            }
        }
        
        // 4. ARçµ±åˆãƒ†ã‚¹ãƒˆ
        async function testAR() {
            const step4 = document.getElementById('step4');
            step4.className = 'step testing';
            document.getElementById('ar-info').textContent = 'ARçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
            
            const container = document.getElementById('ar-test-area');
            container.innerHTML = '';
            
            try {
                // ãƒ“ãƒ‡ã‚ªè¦ç´ 
                const video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.muted = true;
                video.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    z-index: 1;
                `;
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ 
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 200;
                canvas.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 2;
                    pointer-events: auto;
                `;
                
                container.appendChild(video);
                container.appendChild(canvas);
                
                // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ 
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
                
                await new Promise(resolve => {
                    video.addEventListener('loadedmetadata', resolve, { once: true });
                });
                
                // Three.jsã‚·ãƒ¼ãƒ³
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, 300/200, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
                
                renderer.setSize(300, 200);
                renderer.setClearColor(0x000000, 0);
                
                // ãƒ†ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.set(0, 0, -1);
                scene.add(cube);
                
                camera.position.set(0, 0, 0);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
                let arFrame = 0;
                function animate() {
                    arFrame++;
                    if (arFrame > 180) return; // 3ç§’ã§åœæ­¢
                    requestAnimationFrame(animate);
                    cube.rotation.y += 0.02;
                    renderer.render(scene, camera);
                }
                animate();
                
                testResults.ar = { 
                    success: true, 
                    videoWidth: video.videoWidth,
                    videoHeight: video.videoHeight
                };
                step4.className = 'step success';
                document.getElementById('ar-info').innerHTML = `
                    <strong>âœ… æˆåŠŸ!</strong> ARçµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†<br>
                    <strong>ãƒ“ãƒ‡ã‚ªè§£åƒåº¦:</strong> ${video.videoWidth}Ã—${video.videoHeight}<br>
                    ã‚«ãƒ¡ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‰ + 3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é‡ã­åˆã‚ã›è¡¨ç¤ºç¢ºèª
                `;
                
            } catch (error) {
                console.error('ARçµ±åˆã‚¨ãƒ©ãƒ¼:', error);
                testResults.ar = { success: false, error: error.message };
                step4.className = 'step error';
                document.getElementById('ar-info').innerHTML = `
                    <strong>âŒ å¤±æ•—!</strong> ARçµ±åˆã‚¨ãƒ©ãƒ¼<br>
                    ${error.name}: ${error.message}
                `;
            }
        }
        
        // 5. è¨ºæ–­çµæœ
        function generateDiagnosis() {
            const issues = [];
            const fixes = [];
            let severity = 'success';
            
            if (!testResults.device.isHTTPS) {
                issues.push('âŒ HTTPSã§ãªã„');
                fixes.push('ğŸ”§ HTTPSã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ï¼ˆå¿…é ˆï¼‰');
                severity = 'error';
            }
            
            if (!testResults.device.hasGetUserMedia) {
                issues.push('âŒ getUserMediaæœªå¯¾å¿œ');
                fixes.push('ğŸ”§ å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼ˆChrome, Firefox, Safariç­‰ï¼‰');
                severity = 'error';
            }
            
            if (testResults.camera && !testResults.camera.success) {
                issues.push('âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—');
                fixes.push('ğŸ”§ ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
                fixes.push('ğŸ”§ ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„');
                severity = 'error';
            }
            
            if (testResults.webgl && !testResults.webgl.success) {
                issues.push('âŒ WebGLåˆæœŸåŒ–å¤±æ•—');
                fixes.push('ğŸ”§ WebGLå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„');
                fixes.push('ğŸ”§ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
                severity = 'error';
            }
            
            if (testResults.ar && !testResults.ar.success) {
                issues.push('âŒ ARçµ±åˆå¤±æ•—');
                fixes.push('ğŸ”§ ä¸Šè¨˜ã®å•é¡Œã‚’ã™ã¹ã¦è§£æ±ºã—ã¦ãã ã•ã„');
                severity = 'error';
            }
            
            const step5 = document.getElementById('step5');
            if (severity === 'success' && issues.length === 0) {
                step5.className = 'step success';
                document.getElementById('result-info').innerHTML = `
                    <strong>âœ… è¨ºæ–­å®Œäº†!</strong> å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚<br>
                    ARã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã¯ãšã§ã™ã€‚<br><br>
                    <strong>æ¨å¥¨è¨­å®š:</strong><br>
                    â€¢ ãƒ‡ãƒã‚¤ã‚¹: ${testResults.device.isMobileDevice ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}é©åˆ<br>
                    â€¢ ã‚«ãƒ¡ãƒ©: ${testResults.camera?.constraint ? JSON.stringify(testResults.camera.constraint.video) : 'N/A'}<br>
                    â€¢ WebGL: ${testResults.webgl?.version || 'N/A'}
                `;
            } else {
                step5.className = 'step error';
                document.getElementById('result-info').innerHTML = `
                    <strong>âš ï¸ å•é¡Œç™ºè¦‹:</strong><br>
                    ${issues.join('<br>')}<br><br>
                    <strong>ğŸ› ï¸ ä¿®æ­£æ–¹æ³•:</strong><br>
                    ${fixes.join('<br>')}
                `;
            }
        }
        
        // å…¨ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ
        async function runFullTest() {
            console.log('ğŸš€ å…¨ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œé–‹å§‹');
            
            detectDevice();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCamera();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            testWebGL();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testAR();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            generateDiagnosis();
            
            console.log('ğŸ å…¨ãƒ†ã‚¹ãƒˆå®Œäº†', testResults);
        }
        
        // è‡ªå‹•é–‹å§‹
        detectDevice();
        
    </script>
</body>
</html>