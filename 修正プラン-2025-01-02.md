# WebAR 修正プラン（2025-01-02版）

**作成日**: 2025-01-02  
**ステータス**: 緊急対応  
**ベース**: 画像診断結果 + 既存修正プラン

---

## 📊 現状の問題（画像診断から）

### 🔴 P0: クリティカル問題

#### P0-1: `camera_starting` 状態のタイムアウト（30秒）
**症状**:
- スマホでQRコードスキャン後、「開始」ボタンを押すと30秒でタイムアウト
- エラーメッセージ: `状態 "camera_starting" がタイムアウトしました (30000ms)`
- 「読み込み完了」と表示されるが、実際にはエラー状態

**原因分析**:
1. `ar-state-machine.js:307-314` で30秒のタイムアウトが設定されている
2. `ar-viewer.js:3208-3294` の `handleCameraStarting` 関数で以下が時間がかかる可能性:
   - マーカー画像から `.patt` パターン生成（3240行目）
   - ARエンジン初期化（3274-3282行目）
   - 特に、マーカー画像の読み込みとパターン生成が遅い

**修正内容**:
```javascript
// 1. タイムアウト時間の延長（カメラ起動は時間がかかる可能性がある）
// ar-state-machine.js:58
this.defaultTimeout = options.defaultTimeout || 60000; // 30秒 → 60秒

// 2. CAMERA_STARTING 状態専用のタイムアウト設定
// ar-viewer.js:3100-3104
case ARState.CAMERA_STARTING:
  loadingStateManager.startLoading('📷 カメラ起動中...');
  updateGuideScreen(data.fallbackInfo, 'marker');
  showScreen(screenStates.GUIDE);
  // カメラ起動は時間がかかるため、タイムアウトを60秒に延長
  await arStateMachine.transition(ARState.CAMERA_STARTING, data, 60000);
  await handleCameraStarting(data);
  break;

// 3. マーカーパターン生成の進捗表示とタイムアウト対策
// ar-viewer.js:3239-3252
console.log('🔄 マーカーパターン生成開始...');
loadingStateManager.startLoading('🔄 マーカーパターンを生成中...');
const patternString = await Promise.race([
  generateMarkerPatternFromImage(absUrl),
  new Promise((_, reject) => 
    setTimeout(() => reject(new Error('マーカーパターン生成がタイムアウトしました')), 20000)
  )
]).catch((err) => {
  console.error('❌ マーカーパターン生成エラー:', err);
  return null;
});
```

**検証**:
- [ ] カメラ起動が60秒以内に完了すること
- [ ] タイムアウトエラーが発生しないこと
- [ ] マーカーパターン生成の進捗が表示されること

---

#### P0-2: マーカー画像が見つからない問題
**症状**:
- 警告メッセージ: `⚠️ マーカー画像URLが見つかりません`
- 警告メッセージ: `⚠️ カスタムマーカーが設定されていません`
- 警告メッセージ: `🔨 プロジェクト設定でマーカー画像をアップロードしてください`
- ガイド画面は表示されるが、マーカー検出ができない可能性

**原因分析**:
1. `ar-viewer.js:3233` でマーカー画像URLを探索しているが、見つからない
2. `marker-ar.js:198-202` で警告を表示しているが、フォールバック処理が不十分
3. プロジェクトデータに `markerImage` や `markerImageUrl` が保存されていない可能性

**修正内容**:
```javascript
// 1. マーカー画像の探索ロジック強化
// ar-viewer.js:3233-3255
const rawUrl = currentProject?.markerImage 
  || currentProject?.markerImageUrl 
  || currentProject?.marker?.url 
  || currentProject?.marker?.src
  || currentProject?.guide?.marker?.src
  || null;

// 2. フォールバック画像の確実な使用
// marker-ar.js:198-229
if (!this.options.markerUrl) {
  console.warn('⚠️ カスタムマーカーが設定されていません。サンプル画像を使用します。');
  console.warn('📌 プロジェクト設定でマーカー画像をアップロードしてください。');
  
  // フォールバック画像を確実に使用
  const fallbackCandidates = [
    '/assets/sample.png',
    '/assets/logo.png',
    '/assets/main-low.jpg'
  ];
  
  const resolvedImageUrl = await this.resolveAssetUrl(fallbackCandidates);
  if (resolvedImageUrl) {
    console.log('✅ フォールバック画像を使用:', resolvedImageUrl);
    // パターン生成を続行
  } else {
    throw new Error('マーカー画像が見つかりません。プロジェクト設定でマーカー画像をアップロードしてください。');
  }
}

// 3. プロジェクト正規化時のマーカー画像確保
// ar-viewer.js:605-640 (normalizeProject関数内)
// マーカー画像が見つからない場合、デフォルト画像を設定
if (t === 'marker' && !picked) {
  const fb = abs(DEFAULT_MARKER_PATH);
  console.warn('[FLOW] markerImageUrl not found. fallback ->', fb);
  picked = fb;
  
  // 到達性チェック
  const ok = await verifyReachable(picked);
  if (!ok) {
    // さらにフォールバックを試行
    const additionalFallbacks = [
      '/assets/sample.png',
      '/assets/logo.png'
    ];
    for (const fallback of additionalFallbacks) {
      const absFallback = abs(fallback);
      if (await verifyReachable(absFallback)) {
        picked = absFallback;
        break;
      }
    }
  }
}
```

**検証**:
- [ ] マーカー画像が見つからない場合でも、フォールバック画像が使用されること
- [ ] 警告メッセージが適切に表示されること
- [ ] マーカー検出が正常に動作すること

---

## 🟡 P1: 重要修正（UX改善）

### P1-1: エラー時の再試行機能強化
**症状**:
- エラー発生時に「再試行」ボタンが表示されるが、状態がリセットされない可能性

**修正内容**:
```javascript
// ar-viewer.js:3131-3134
case ARState.ERROR:
  loadingStateManager.setError(data.error?.message || 'AR起動エラー');
  handleARError(data.error, oldState, data);
  
  // 再試行ボタンの追加
  const retryBtn = document.createElement('button');
  retryBtn.textContent = '再試行';
  retryBtn.onclick = async () => {
    await arStateMachine.reset();
    await arStateMachine.transition(ARState.LAUNCH_REQUESTED);
  };
  // UIに追加
  break;
```

**検証**:
- [ ] エラー時に再試行ボタンが表示されること
- [ ] 再試行で正常に動作すること

---

### P1-2: ローディング状態の詳細表示
**症状**:
- ローディング中に何をしているか分かりにくい

**修正内容**:
```javascript
// ar-viewer.js:3208-3294 (handleCameraStarting内)
// 各ステップでローディング状態を更新
loadingStateManager.startLoading('🔄 マーカーパターンを準備中...');
// マーカーパターン生成
loadingStateManager.startLoading('📷 ARエンジンを初期化中...');
// ARエンジン初期化
loadingStateManager.startLoading('📹 カメラを起動中...');
// カメラ起動
```

**検証**:
- [ ] 各ステップで適切なメッセージが表示されること

---

## 🟢 P2: 改善（将来対応）

### P2-1: デバッグコンソールの自動表示停止
**症状**:
- スマホでデバッグコンソールが自動表示されている

**修正内容**:
- `DEV_VERBOSE_LOGS` フラグで制御
- 本番環境では自動表示を無効化

---

## 📋 実装優先順位

```
Day 1: P0-1 (タイムアウト延長)
Day 2: P0-2 (マーカー画像フォールバック強化)
Day 3: P1-1, P1-2 (UX改善)
```

---

## ✅ 検証チェックリスト

### 基本動作
- [ ] QRコードスキャン → スタート → カメラ起動（60秒以内）
- [ ] マーカー画像が見つからない場合でも、フォールバック画像で動作
- [ ] エラー時に再試行が可能

### エラーハンドリング
- [ ] タイムアウトエラーが発生しない
- [ ] マーカー画像が見つからない場合の適切な警告表示
- [ ] 再試行機能が正常に動作

### パフォーマンス
- [ ] カメラ起動が60秒以内に完了
- [ ] マーカーパターン生成が20秒以内に完了

---

## 🚨 緊急時対応

### ロールバック手順
```bash
git revert HEAD
npm run build && npm run preview
```

### Feature Flag による無効化
```javascript
// src/config/feature-flags.js
export const DEV_VERBOSE_LOGS = false;  // デバッグログ無効化
```

---

**最終更新**: 2025-01-02  
**次回レビュー**: 実装完了後

